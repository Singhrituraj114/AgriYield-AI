<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>AgriYield AI</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link  rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#020d14;
  --glass:rgba(255,255,255,0.04);
  --glass-border:rgba(255,255,255,0.09);
  --accent:#00e5a0;
  --accent2:#0ea5e9;
  --accent3:#f59e0b;
  --accent4:#a78bfa;
  --text:#e2e8f0;
  --muted:#64748b;
  --r:20px;
}
/* ‚îÄ‚îÄ Animatable CSS custom properties (Chrome/Edge/Safari) ‚îÄ‚îÄ */
@property --accent  { syntax:'<color>'; inherits:true; initial-value:#00e5a0; }
@property --accent2 { syntax:'<color>'; inherits:true; initial-value:#0ea5e9; }
@property --accent3 { syntax:'<color>'; inherits:true; initial-value:#f59e0b; }
/* ‚îÄ‚îÄ Season palette body classes ‚îÄ‚îÄ */
body{ transition: --accent 1.4s, --accent2 1.4s, --accent3 1.4s, background-color 1.8s; }
body.season-kharif  { --accent:#0ea5e9; --accent2:#06b6d4; --accent3:#34d399; background-color:#020d18; }
body.season-rabi    { --accent:#a3e635; --accent2:#84cc16; --accent3:#fde68a; background-color:#04100a; }
body.season-summer  { --accent:#f59e0b; --accent2:#ef4444; --accent3:#fde68a; background-color:#0d0800; }
body.season-winter  { --accent:#93c5fd; --accent2:#c7d2fe; --accent3:#dbeafe; background-color:#030810; }
body.season-autumn  { --accent:#fb923c; --accent2:#f59e0b; --accent3:#fca5a5; background-color:#0c0500; }
body.season-whole   { --accent:#00e5a0; --accent2:#0ea5e9; --accent3:#f59e0b; background-color:#020d14; }
/* ‚îÄ‚îÄ Season Overlay canvas ‚îÄ‚îÄ */
#season-overlay{
  position:fixed;top:0;left:0;width:100%;height:100%;
  z-index:3;pointer-events:none;opacity:0;
  transition:opacity 1.6s ease;
}
#season-overlay.sx-active{opacity:1;}
/* ‚îÄ‚îÄ Reduced motion ‚îÄ‚îÄ */
@media(prefers-reduced-motion:reduce){
  #season-overlay,#weather-canvas{display:none!important;}
  body,*{transition:color .3s,background-color .3s!important;}
}
*{margin:0;padding:0;box-sizing:border-box}
/* Global dropdown option fix ‚Äî dark background so text is always readable */
select option{background:#1a2235;color:#e8f4f8;}
select option:checked,select option:hover{background:#0ea5e9;color:#fff;}
html{scroll-behavior:smooth}
body{width:100%;min-height:100vh;background:var(--bg);font-family:'Inter',sans-serif;color:var(--text);overflow-x:hidden}

/* CANVAS */
#bg-canvas{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none}

/* PAGE WRAP */
.page{position:relative;z-index:1}

/* NAV */
nav{display:flex;align-items:center;justify-content:space-between;padding:18px 56px;
  backdrop-filter:blur(24px);border-bottom:1px solid var(--glass-border);
  background:rgba(2,13,20,0.7);position:sticky;top:0;z-index:200}
.nav-logo{font-size:1.35rem;font-weight:900;background:linear-gradient(135deg,var(--accent),var(--accent2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-.02em}
.nav-links{display:flex;gap:36px;align-items:center}
.nav-links a{color:var(--muted);text-decoration:none;font-size:.88rem;font-weight:500;
  transition:.25s;cursor:pointer;letter-spacing:.01em}
.nav-links a:hover{color:var(--accent)}
.nav-pill{background:linear-gradient(135deg,var(--accent),var(--accent2));
  color:#020d14!important;padding:8px 20px;border-radius:999px;font-weight:700!important;
  font-size:.82rem!important;letter-spacing:.04em}

/* HERO */
.hero{min-height:94vh;display:flex;flex-direction:column;align-items:center;
  justify-content:center;text-align:center;padding:60px 24px 40px;gap:28px;position:relative}
.hero-badge{display:inline-flex;align-items:center;gap:8px;
  background:rgba(0,229,160,.08);border:1px solid rgba(0,229,160,.25);
  color:var(--accent);padding:7px 20px;border-radius:999px;font-size:.78rem;
  font-weight:700;letter-spacing:.1em;text-transform:uppercase}
.hero-badge span{width:7px;height:7px;background:var(--accent);border-radius:50%;
  animation:pulse 1.8s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.7)}}
.hero h1{font-size:clamp(3rem,8vw,6.5rem);font-weight:900;line-height:1.04;
  letter-spacing:-.04em;max-width:900px}
.hero h1 .g{background:linear-gradient(135deg,var(--accent) 0%,var(--accent2) 60%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hero p{font-size:1.1rem;color:var(--muted);max-width:560px;line-height:1.75}
.hero-cta{display:flex;gap:14px;flex-wrap:wrap;justify-content:center;margin-top:8px}
.btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent2));
  color:#020d14;border:none;padding:15px 40px;border-radius:999px;font-size:1rem;
  font-weight:800;cursor:pointer;transition:.3s;box-shadow:0 0 40px rgba(0,229,160,.25);
  font-family:inherit;letter-spacing:.01em}
.btn-primary:hover{transform:translateY(-3px);box-shadow:0 0 60px rgba(0,229,160,.45)}
.btn-ghost{background:transparent;color:var(--text);border:1px solid var(--glass-border);
  padding:15px 40px;border-radius:999px;font-size:1rem;font-weight:600;cursor:pointer;
  transition:.3s;font-family:inherit}
.btn-ghost:hover{border-color:var(--accent);color:var(--accent);transform:translateY(-3px)}
.hero-scroll{position:absolute;bottom:40px;left:50%;transform:translateX(-50%);
  display:flex;flex-direction:column;align-items:center;gap:8px;color:var(--muted);font-size:.75rem;
  letter-spacing:.1em;text-transform:uppercase;animation:bounce 2s ease-in-out infinite}
@keyframes bounce{0%,100%{transform:translateX(-50%) translateY(0)}50%{transform:translateX(-50%) translateY(8px)}}
.scroll-line{width:1px;height:40px;background:linear-gradient(var(--accent),transparent)}

/* STATS */
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
  gap:18px;padding:0 56px 72px}
.stat-card{background:var(--glass);border:1px solid var(--glass-border);border-radius:var(--r);
  padding:28px 20px;text-align:center;backdrop-filter:blur(20px);transition:.35s;cursor:default;
  position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,transparent,var(--accent),transparent);opacity:0;transition:.35s}
.stat-card:hover{transform:translateY(-8px);border-color:rgba(0,229,160,.3);
  box-shadow:0 20px 60px rgba(0,229,160,.1)}
.stat-card:hover::before{opacity:1}
.stat-num{font-size:1.9rem;font-weight:900;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent}
.stat-label{font-size:.75rem;color:var(--muted);margin-top:8px;font-weight:600;
  text-transform:uppercase;letter-spacing:.07em}

/* SECTION */
section{padding:80px 56px}
section:nth-child(even){background:rgba(255,255,255,.012)}
.section-label{font-size:.75rem;font-weight:700;color:var(--accent);
  text-transform:uppercase;letter-spacing:.12em;margin-bottom:12px}
.section-title{font-size:2.2rem;font-weight:800;letter-spacing:-.03em;margin-bottom:10px}
.section-sub{color:var(--muted);font-size:.95rem;margin-bottom:44px;line-height:1.7;max-width:560px}

/* GLASS CARD */
.glass-card{background:var(--glass);border:1px solid var(--glass-border);
  border-radius:var(--r);padding:32px;backdrop-filter:blur(24px)}

/* PREDICT SECTION */
.predict-grid{display:grid;grid-template-columns:1fr 1fr;gap:28px}
@media(max-width:900px){.predict-grid{grid-template-columns:1fr}}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
.form-group{display:flex;flex-direction:column;gap:8px}
.form-group.full{grid-column:1/-1}
.form-group label{font-size:.75rem;color:var(--muted);font-weight:700;
  text-transform:uppercase;letter-spacing:.08em}
.form-group select,.form-group input[type=number]{
  background:rgba(255,255,255,.05);border:1px solid var(--glass-border);
  color:var(--text);padding:13px 16px;border-radius:12px;
  font-size:.93rem;font-family:inherit;outline:none;transition:.25s;
  appearance:none;-webkit-appearance:none;cursor:pointer}
.form-group select option{
  background:#1a2235;color:#e8f4f8;padding:8px 12px;}
.form-group select option:hover,.form-group select option:checked{
  background:#0ea5e9;color:#fff;}
.form-group select:focus,.form-group input[type=number]:focus{
  border-color:var(--accent);box-shadow:0 0 0 3px rgba(0,229,160,.1);background:rgba(0,229,160,.04)}
.range-wrap{display:flex;flex-direction:column;gap:10px}
.range-top{display:flex;justify-content:space-between;align-items:center}
.range-val{font-size:1rem;font-weight:800;color:var(--accent)}
input[type=range]{-webkit-appearance:none;appearance:none;width:100%;height:5px;
  border-radius:999px;background:rgba(255,255,255,.1);outline:none;cursor:pointer}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;
  width:18px;height:18px;border-radius:50%;background:var(--accent);
  box-shadow:0 0 12px rgba(0,229,160,.5);transition:.2s}
input[type=range]::-webkit-slider-thumb:hover{transform:scale(1.3)}
.predict-btn{width:100%;margin-top:28px;padding:17px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  color:#020d14;border:none;border-radius:14px;font-size:1rem;font-weight:800;
  cursor:pointer;transition:.3s;letter-spacing:.02em;font-family:inherit;
  box-shadow:0 0 30px rgba(0,229,160,.2)}
.predict-btn:hover{transform:translateY(-2px);box-shadow:0 0 50px rgba(0,229,160,.4)}
.predict-btn:disabled{opacity:.45;cursor:not-allowed;transform:none;box-shadow:none}

/* RESULT PANEL */
.result-panel{display:flex;flex-direction:column;gap:18px;min-height:300px}
.placeholder{display:flex;flex-direction:column;align-items:center;justify-content:center;
  flex:1;gap:16px;color:var(--muted);text-align:center;padding:60px 20px}
.placeholder-icon{font-size:3.5rem;opacity:.25;animation:float 3s ease-in-out infinite}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
.result-main{background:linear-gradient(135deg,rgba(0,229,160,.07),rgba(14,165,233,.07));
  border:1px solid rgba(0,229,160,.2);border-radius:18px;padding:32px;text-align:center}
.result-main .rlabel{font-size:.75rem;color:var(--muted);font-weight:700;
  text-transform:uppercase;letter-spacing:.1em;margin-bottom:12px}
.result-main .rval{font-size:4rem;font-weight:900;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1}
.result-main .runit{font-size:.85rem;color:var(--muted);margin-top:8px}
.result-row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.result-mini{border-radius:14px;padding:20px;text-align:center}
.result-mini.blue{background:rgba(14,165,233,.07);border:1px solid rgba(14,165,233,.2)}
.result-mini.amber{background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.2)}
.result-mini .rlabel{font-size:.72rem;color:var(--muted);font-weight:700;
  text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px}
.result-mini .rval{font-size:1.6rem;font-weight:800}
.result-mini.blue .rval{color:var(--accent2)}
.result-mini.amber .rval{color:var(--accent3)}
.result-info{background:rgba(255,255,255,.03);border-radius:12px;padding:16px;
  font-size:.83rem;color:var(--muted);line-height:1.8}
.result-info b{color:var(--text)}

/* FORECAST */
.forecast-box{margin-top:28px}
.forecast-box .flabel{font-size:.75rem;font-weight:700;color:var(--muted);
  text-transform:uppercase;letter-spacing:.1em;margin-bottom:14px}
.forecast-wrap{position:relative;height:200px}

/* ANALYTICS */
.tab-bar{display:flex;gap:6px;margin-bottom:36px;background:rgba(255,255,255,.03);
  border-radius:14px;padding:5px;width:fit-content;border:1px solid var(--glass-border)}
.tab{padding:10px 26px;border-radius:10px;border:none;background:transparent;
  color:var(--muted);font-size:.88rem;font-weight:600;cursor:pointer;
  transition:.2s;font-family:inherit}
.tab.active{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#020d14}
.tab:hover:not(.active){color:var(--text)}
.tab-pane{display:none}
.tab-pane.active{display:block}
.charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:24px}
.chart-card{background:var(--glass);border:1px solid var(--glass-border);border-radius:var(--r);
  padding:28px;backdrop-filter:blur(20px);transition:.3s}
.chart-card:hover{border-color:rgba(255,255,255,.15);box-shadow:0 8px 40px rgba(0,0,0,.3)}
.chart-card h3{font-size:.92rem;font-weight:700;margin-bottom:20px;
  color:var(--text);letter-spacing:-.01em}
.chart-area{position:relative;height:270px}
.chart-area.tall{height:360px}

/* SHAP */
.shap-info{font-size:.82rem;color:var(--muted);margin-bottom:24px;line-height:1.8}
.shap-row{display:flex;align-items:center;gap:14px;margin-bottom:10px}
.shap-label{width:72px;font-size:.8rem;color:var(--muted);font-weight:700;
  text-align:right;flex-shrink:0;text-transform:uppercase;letter-spacing:.05em}
.shap-bar-bg{flex:1;height:32px;background:rgba(255,255,255,.04);
  border-radius:10px;overflow:hidden;border:1px solid var(--glass-border)}
.shap-bar{height:100%;border-radius:9px;transition:width 1.2s cubic-bezier(.16,1,.3,1);
  display:flex;align-items:center;padding:0 12px;font-size:.76rem;font-weight:800;
  color:#020d14;min-width:4px;white-space:nowrap}
.shap-val{width:80px;font-size:.82rem;font-weight:800;flex-shrink:0}
.shap-base{display:inline-flex;align-items:center;gap:10px;
  background:rgba(0,229,160,.06);border:1px solid rgba(0,229,160,.15);
  padding:10px 18px;border-radius:10px;font-size:.83rem;margin-bottom:24px}

/* DATA TABLE */
.tbl-toolbar{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap}
.tbl-search{flex:1;min-width:220px;background:rgba(255,255,255,.05);
  border:1px solid var(--glass-border);color:var(--text);padding:11px 16px;
  border-radius:12px;font-size:.9rem;font-family:inherit;outline:none;transition:.2s}
.tbl-search:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(0,229,160,.1)}
.tbl-refresh{background:transparent;color:var(--muted);border:1px solid var(--glass-border);
  padding:11px 20px;border-radius:12px;font-size:.85rem;cursor:pointer;
  font-family:inherit;transition:.2s;white-space:nowrap}
.tbl-refresh:hover{color:var(--accent);border-color:var(--accent)}
.tbl-wrap{overflow-x:auto;border-radius:16px;border:1px solid var(--glass-border)}
table{width:100%;border-collapse:collapse;font-size:.84rem}
thead tr{background:rgba(255,255,255,.05)}
th{padding:14px 18px;text-align:left;font-weight:700;color:var(--muted);
  font-size:.73rem;text-transform:uppercase;letter-spacing:.08em;
  border-bottom:1px solid var(--glass-border);white-space:nowrap}
td{padding:12px 18px;border-bottom:1px solid rgba(255,255,255,.035);white-space:nowrap}
tbody tr{transition:.2s}
tbody tr:hover{background:rgba(0,229,160,.03)}
tbody tr:last-child td{border-bottom:none}
.badge{display:inline-block;padding:3px 10px;border-radius:999px;
  font-size:.72rem;font-weight:700;letter-spacing:.04em}
.badge-kharif{background:rgba(245,158,11,.15);color:var(--accent3)}
.badge-rabi{background:rgba(14,165,233,.15);color:var(--accent2)}
.badge-whole{background:rgba(0,229,160,.12);color:var(--accent)}
.badge-other{background:rgba(167,139,250,.12);color:var(--accent4)}
.tbl-foot{display:flex;justify-content:space-between;align-items:center;
  margin-top:14px;font-size:.8rem;color:var(--muted)}

/* TOAST */
#toast{position:fixed;bottom:32px;right:32px;z-index:9999;
  background:rgba(2,13,20,.95);border:1px solid rgba(0,229,160,.4);
  color:var(--accent);padding:14px 24px;border-radius:14px;
  font-size:.88rem;font-weight:600;backdrop-filter:blur(20px);
  opacity:0;transform:translateY(20px);transition:.4s cubic-bezier(.16,1,.3,1);pointer-events:none;
  box-shadow:0 8px 32px rgba(0,229,160,.15)}
#toast.show{opacity:1;transform:translateY(0)}
#toast.error{border-color:rgba(248,113,113,.4);color:#f87171;box-shadow:0 8px 32px rgba(248,113,113,.1)}

/* SPINNER */
.spinner{width:36px;height:36px;border:3px solid rgba(0,229,160,.1);
  border-top-color:var(--accent);border-radius:50%;
  animation:spin .7s linear infinite;margin:40px auto}
@keyframes spin{to{transform:rotate(360deg)}}

/* FOOTER */
footer{text-align:center;padding:48px 24px;color:var(--muted);
  font-size:.83rem;border-top:1px solid var(--glass-border);line-height:2}
footer .accent{color:var(--accent)}

/* FADE-UP */
.fu{opacity:0;transform:translateY(36px)}

/* SCROLLBAR */
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08);border-radius:999px}
::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.15)}

/* MAP */
#india-map{height:520px;border-radius:16px;background:#0a1a24;z-index:1}
.leaflet-container{background:#0a1a24!important;font-family:'Inter',sans-serif}
.leaflet-popup-content-wrapper{background:rgba(2,13,20,.95);color:#e2e8f0;
  border:1px solid rgba(0,229,160,.3);border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.5)}
.leaflet-popup-tip{background:rgba(2,13,20,.95)}
.leaflet-popup-content{margin:12px 16px;font-size:.85rem;line-height:1.8}
.map-legend{background:rgba(2,13,20,.9);padding:14px 18px;border-radius:12px;
  border:1px solid var(--glass-border);font-size:.78rem;line-height:2;color:var(--muted)}
.map-legend b{color:var(--text);display:block;margin-bottom:6px;font-size:.82rem}
.legend-item{display:flex;align-items:center;gap:8px}
.legend-swatch{width:14px;height:14px;border-radius:4px;flex-shrink:0}
.map-overlay-info{background:rgba(2,13,20,.88);padding:12px 18px;border-radius:12px;
  border:1px solid var(--glass-border);font-size:.82rem;color:var(--muted);pointer-events:none}

/* CONTEXTUAL ANALYSIS */
.ctx-section{margin-top:40px}
.ctx-header{display:flex;align-items:center;justify-content:space-between;
  margin-bottom:24px;flex-wrap:wrap;gap:12px}
.ctx-title{font-size:1.3rem;font-weight:800;letter-spacing:-.02em}
.ctx-badge{display:inline-flex;align-items:center;gap:8px;padding:7px 16px;
  background:rgba(0,229,160,.08);border:1px solid rgba(0,229,160,.2);
  border-radius:999px;font-size:.78rem;font-weight:700;color:var(--accent)}
.ctx-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:14px;margin-bottom:28px}
.ctx-stat{background:var(--glass);border:1px solid var(--glass-border);border-radius:14px;
  padding:18px;text-align:center}
.ctx-stat .cv{font-size:1.5rem;font-weight:800;color:var(--accent)}
.ctx-stat .cl{font-size:.72rem;color:var(--muted);font-weight:600;text-transform:uppercase;
  letter-spacing:.07em;margin-top:4px}
.ctx-charts{display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:22px}

/* ‚ïê‚ïê‚ïê RESPONSIVE ‚ïê‚ïê‚ïê */
@media(max-width:900px){
  .charts-grid{grid-template-columns:1fr}
  .ctx-charts{grid-template-columns:1fr}
  .predict-grid{grid-template-columns:1fr}
  .batch-row{grid-template-columns:1fr 1fr 1fr 1fr;font-size:.75rem}
  .batch-row.bh{grid-template-columns:1fr 1fr 1fr 1fr}
}

/* ‚ïê‚ïê‚ïê WEATHER CANVAS ‚ïê‚ïê‚ïê */
#weather-canvas{position:fixed;top:0;left:0;width:100%;height:100%;z-index:2;pointer-events:none;opacity:0;transition:opacity 1.4s}
#weather-canvas.wx-active{opacity:1}
/* ‚ïê‚ïê‚ïê SEASON BADGE ‚ïê‚ïê‚ïê */
#season-badge{position:fixed;top:76px;left:24px;z-index:300;padding:6px 16px;border-radius:999px;font-size:.74rem;font-weight:700;background:rgba(2,13,20,.9);border:1px solid var(--glass-border);backdrop-filter:blur(14px);color:var(--muted);transition:all .6s cubic-bezier(.16,1,.3,1);pointer-events:none;display:flex;align-items:center;gap:7px;letter-spacing:.03em;box-shadow:0 4px 18px rgba(0,0,0,.3)}
/* ‚ïê‚ïê‚ïê IRIDESCENT CARD HOVER ‚ïê‚ïê‚ïê */
@keyframes iri-cycle{
  0%  {border-color:rgba(0,229,160,.35);  box-shadow:0 24px 60px rgba(0,229,160,.12),  inset 0 1px 0 rgba(0,229,160,.1)}
  25% {border-color:rgba(14,165,233,.35); box-shadow:0 24px 60px rgba(14,165,233,.12), inset 0 1px 0 rgba(14,165,233,.1)}
  50% {border-color:rgba(167,139,250,.35);box-shadow:0 24px 60px rgba(167,139,250,.12),inset 0 1px 0 rgba(167,139,250,.1)}
  75% {border-color:rgba(245,158,11,.35); box-shadow:0 24px 60px rgba(245,158,11,.12), inset 0 1px 0 rgba(245,158,11,.1)}
  100%{border-color:rgba(0,229,160,.35);  box-shadow:0 24px 60px rgba(0,229,160,.12),  inset 0 1px 0 rgba(0,229,160,.1)}}
.glass-card,.chart-card,.stat-card,.ctx-stat{will-change:transform}
.glass-card:hover,.chart-card:hover{transform:perspective(900px) translateY(-7px) rotateX(1.5deg);animation:iri-cycle 2.5s linear infinite}
.stat-card:hover,.ctx-stat:hover{animation:iri-cycle 2.5s linear infinite}
.glass-card::after,.chart-card::after{content:'';position:absolute;top:0;left:10%;right:10%;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.5),transparent);opacity:0;transition:opacity .4s;pointer-events:none}
.glass-card:hover::after,.chart-card:hover::after{opacity:1}
/* ‚ïê‚ïê‚ïê HOLOGRAPHIC REVEAL ‚ïê‚ïê‚ïê */
.result-main{position:relative;overflow:hidden}
@keyframes holo-scan{0%{transform:translateY(-100%) skewX(-4deg);opacity:.6}100%{transform:translateY(380%) skewX(-4deg);opacity:0}}
@keyframes holo-glow{0%,100%{text-shadow:0 0 30px rgba(0,229,160,.4),0 0 60px rgba(0,229,160,.2)}50%{text-shadow:0 0 70px rgba(0,229,160,.8),0 0 120px rgba(0,229,160,.4)}}
.rval.glowing{animation:holo-glow 2.4s ease-in-out infinite}
.holo-sweep{position:absolute;left:0;top:0;width:100%;height:40%;background:linear-gradient(180deg,transparent,rgba(0,229,160,.12),rgba(0,229,160,.05),transparent);animation:holo-scan 1s ease-out forwards;pointer-events:none}
/* ‚ïê‚ïê‚ïê RIPPLE ‚ïê‚ïê‚ïê */
.predict-btn,.btn-primary{position:relative;overflow:hidden}
.ripple{position:absolute;border-radius:50%;background:rgba(255,255,255,.3);transform:scale(0);animation:ripple-anim .7s linear;pointer-events:none}
@keyframes ripple-anim{to{transform:scale(4.5);opacity:0}}
/* ‚ïê‚ïê‚ïê CONFIDENCE INTERVAL ‚ïê‚ïê‚ïê */
.conf-wrap{margin-top:16px;padding:14px 18px;background:rgba(255,255,255,.03);border:1px solid var(--glass-border);border-radius:12px}
.conf-title{font-size:.71rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px}
.conf-track{position:relative;height:9px;background:rgba(255,255,255,.07);border-radius:999px;margin:5px 0}
.conf-range{position:absolute;height:100%;border-radius:999px;background:linear-gradient(90deg,rgba(248,113,113,.5),rgba(0,229,160,.5));transition:all 1.2s cubic-bezier(.16,1,.3,1)}
.conf-dot{position:absolute;width:13px;height:13px;border-radius:50%;top:50%;transform:translate(-50%,-50%);background:var(--accent);box-shadow:0 0 12px rgba(0,229,160,.7);transition:left 1.2s cubic-bezier(.16,1,.3,1)}
.conf-bounds{display:flex;justify-content:space-between;font-size:.74rem;margin-top:4px}
.conf-lo{color:#f87171;font-weight:700}.conf-hi{color:var(--accent);font-weight:700}
/* ‚ïê‚ïê‚ïê NEON GLOW ‚ïê‚ïê‚ïê */
@keyframes neon-pulse{0%,100%{filter:drop-shadow(0 0 6px rgba(0,229,160,.3))}50%{filter:drop-shadow(0 0 18px rgba(0,229,160,.8))}}
.stat-num.glowing{animation:neon-pulse 1.6s ease-in-out}
/* ‚ïê‚ïê‚ïê SHAP STAGGER ‚ïê‚ïê‚ïê */
@keyframes shap-in{from{transform:translateX(-24px);opacity:0}to{transform:translateX(0);opacity:1}}
.shap-row{animation:shap-in .45s ease both}
/* ‚ïê‚ïê‚ïê CROP RECOMMENDER ‚ïê‚ïê‚ïê */
.rec-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(175px,1fr));gap:16px;margin-top:22px}
.rec-card{background:var(--glass);border:1px solid var(--glass-border);border-radius:18px;padding:22px 18px;text-align:center;cursor:default;transition:.3s;position:relative;overflow:hidden}
.rec-card:hover{transform:translateY(-8px);border-color:rgba(0,229,160,.35);box-shadow:0 18px 50px rgba(0,229,160,.12)}
.rec-rank{position:absolute;top:10px;right:12px;font-size:.68rem;font-weight:900;background:rgba(255,255,255,.06);padding:2px 8px;border-radius:999px;color:var(--muted)}
.rec-rank.gold{color:#f59e0b;background:rgba(245,158,11,.12)}.rec-rank.silver{color:#94a3b8;background:rgba(148,163,184,.1)}.rec-rank.bronze{color:#cd7c54;background:rgba(205,124,84,.1)}
.rec-icon{font-size:2.3rem;margin-bottom:10px}.rec-name{font-size:.88rem;font-weight:700;color:var(--text);margin-bottom:8px}
.rec-yield{font-size:1.6rem;font-weight:900;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1}
.rec-unit{font-size:.71rem;color:var(--muted);margin-top:3px}
.rec-bar-bg{height:4px;background:rgba(255,255,255,.07);border-radius:999px;margin-top:12px}
.rec-bar{height:100%;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width 1.3s cubic-bezier(.16,1,.3,1)}
/* ‚ïê‚ïê‚ïê HISTORY PANEL ‚ïê‚ïê‚ïê */
#history-panel{position:fixed;top:0;right:-410px;width:390px;height:100vh;background:rgba(2,10,16,.97);backdrop-filter:blur(32px);border-left:1px solid var(--glass-border);z-index:600;transition:.45s cubic-bezier(.16,1,.3,1);overflow-y:auto;padding:28px 22px}
#history-panel.open{right:0}
.hist-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:599;opacity:0;pointer-events:none;transition:.35s}
.hist-overlay.show{opacity:1;pointer-events:all}
.hist-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:22px}
.hist-title{font-size:1.1rem;font-weight:800}
.hist-close{background:transparent;border:1px solid var(--glass-border);color:var(--muted);width:36px;height:36px;border-radius:50%;cursor:pointer;font-size:1.2rem;display:flex;align-items:center;justify-content:center;transition:.2s;line-height:1}
.hist-close:hover{color:var(--text);border-color:var(--text)}
.hist-item{background:var(--glass);border:1px solid var(--glass-border);border-radius:14px;padding:15px;margin-bottom:12px;cursor:pointer;transition:.25s}
.hist-item:hover{border-color:rgba(0,229,160,.3);transform:translateX(-4px)}
.hist-crop{font-weight:700;font-size:.93rem;color:var(--accent)}.hist-meta{font-size:.76rem;color:var(--muted);margin-top:5px;line-height:1.7}
.hist-yield-badge{float:right;font-size:1.25rem;font-weight:900;color:var(--accent2)}.hist-time{font-size:.67rem;color:var(--muted);margin-top:6px;opacity:.5}
/* ‚ïê‚ïê‚ïê BATCH PREDICT ‚ïê‚ïê‚ïê */
.batch-area{width:100%;min-height:150px;background:rgba(255,255,255,.04);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);padding:16px;font-family:'Courier New',monospace;font-size:.82rem;outline:none;resize:vertical;line-height:1.7;transition:.2s}
.batch-area:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(0,229,160,.08)}
.batch-row{display:grid;grid-template-columns:2fr 1.1fr 1.4fr .65fr .75fr 1.1fr;gap:8px;padding:10px 14px;border-radius:10px;font-size:.81rem;border:1px solid var(--glass-border);background:var(--glass);margin-bottom:8px;align-items:center}
.batch-row.bh{background:rgba(255,255,255,.04);font-weight:700;font-size:.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:.05em}
.batch-yc{font-weight:800;color:var(--accent)}
/* ‚ïê‚ïê‚ïê CROP COMPARE ‚ïê‚ïê‚ïê */
.cmp-inputs{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:20px}
.cmp-chip{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;background:rgba(0,229,160,.08);border:1px solid rgba(0,229,160,.25);border-radius:999px;font-size:.82rem;font-weight:600;color:var(--accent);cursor:pointer;transition:.2s}
.cmp-chip:hover{background:rgba(248,113,113,.08);border-color:rgba(248,113,113,.3);color:#f87171}
.cmp-select{background:rgba(255,255,255,.05);border:1px solid var(--glass-border);color:var(--text);padding:9px 14px;border-radius:10px;font-family:inherit;font-size:.84rem;outline:none;cursor:pointer}
.cmp-select option{background:#1a2235;color:#e8f4f8;}
.cmp-select option:hover,.cmp-select option:checked{background:#0ea5e9;color:#fff;}
.cmp-add-btn{padding:9px 18px;background:transparent;border:1px dashed var(--glass-border);color:var(--muted);border-radius:10px;font-family:inherit;font-size:.84rem;cursor:pointer;transition:.2s}
.cmp-add-btn:hover{border-color:var(--accent);color:var(--accent)}
.cmp-table{width:100%;border-collapse:separate;border-spacing:0 8px}
.cmp-table th{font-size:.72rem;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.06em;padding:10px 16px;text-align:left;background:rgba(255,255,255,.03);border-bottom:1px solid var(--glass-border)}
.cmp-table td{padding:13px 16px;background:var(--glass);border-top:1px solid var(--glass-border);border-bottom:1px solid var(--glass-border)}
.cmp-table td:first-child{border-left:1px solid var(--glass-border);border-radius:12px 0 0 12px}
.cmp-table td:last-child{border-right:1px solid var(--glass-border);border-radius:0 12px 12px 0}
.cmp-bar-bg{height:6px;background:rgba(255,255,255,.07);border-radius:999px;margin-top:5px}
.cmp-bar{height:100%;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width 1.2s cubic-bezier(.16,1,.3,1)}
</style>
</head>
<body>

<canvas id="bg-canvas"></canvas>
<canvas id="weather-canvas"></canvas>
<canvas id="season-overlay"></canvas>
<div id="season-badge">üåø Whole Year</div>

<div class="page">

<!-- NAV -->
<nav>
  <div class="nav-logo">üåæ AgriYield AI</div>
  <div class="nav-links">
    <a onclick="nav('hero')">Home</a>
    <a onclick="nav('predict')">Predict</a>
    <a onclick="nav('recommend')">üå± Recommend</a>
    <a onclick="nav('analytics')">Analytics</a>
    <a onclick="nav('data')">Data</a>
    <a onclick="toggleHistory()" style="display:flex;align-items:center;gap:5px">üìã History</a>
    <a class="nav-pill" onclick="nav('predict')">Try Now ‚Üí</a>
  </div>
</nav>

<!-- HERO -->
<section class="hero" id="hero">
  <div class="hero-badge"><span></span>Live AI Predictions</div>
  <h1>India's Smartest<br/><span class="g">Crop Yield AI</span></h1>
  <p>246,000+ records. RandomForest ML model. SHAP explainability. Real-time predictions for any state, crop, and season across India.</p>
  <div class="hero-cta">
    <button class="btn-primary" onclick="nav('predict')">‚ö° Start Predicting</button>
    <button class="btn-ghost" onclick="nav('analytics')">üìä View Analytics</button>
  </div>
  <div class="hero-scroll">
    <div class="scroll-line"></div>
    scroll
  </div>
</section>

<!-- STATS ROW -->
<div class="stats-row" id="stats-row">
  <div class="stat-card fu"><div class="stat-num" id="s-records">‚Äî</div><div class="stat-label">Total Records</div></div>
  <div class="stat-card fu"><div class="stat-num" id="s-states">‚Äî</div><div class="stat-label">States</div></div>
  <div class="stat-card fu"><div class="stat-num" id="s-crops">‚Äî</div><div class="stat-label">Crop Types</div></div>
  <div class="stat-card fu"><div class="stat-num" id="s-seasons">‚Äî</div><div class="stat-label">Seasons</div></div>
  <div class="stat-card fu"><div class="stat-num" id="s-years">‚Äî</div><div class="stat-label">Year Range</div></div>
  <div class="stat-card fu"><div class="stat-num" id="s-yield">‚Äî</div><div class="stat-label">Avg Yield T/Ha</div></div>
</div>

<!-- PREDICT -->
<section id="predict">
  <div class="section-label">AI Prediction Engine</div>
  <div class="section-title">üîÆ Yield Predictor</div>
  <div class="section-sub">Enter your farm parameters below to get an instant AI-powered yield and production estimate with SHAP explainability.</div>

  <div class="predict-grid">
    <!-- FORM CARD -->
    <div class="glass-card fu">
      <div class="form-grid">
        <div class="form-group full">
          <label>State</label>
          <select id="f-state"><option>Loading‚Ä¶</option></select>
        </div>
        <div class="form-group">
          <label>Season</label>
          <select id="f-season"><option>Loading‚Ä¶</option></select>
        </div>
        <div class="form-group">
          <label>Crop</label>
          <select id="f-crop"><option>Loading‚Ä¶</option></select>
        </div>
        <div class="form-group full">
          <div class="range-wrap">
            <div class="range-top">
              <label>Crop Year</label>
              <span class="range-val" id="year-val">2025</span>
            </div>
            <input type="range" id="f-year" min="2000" max="2035" value="2025"
              oninput="document.getElementById('year-val').textContent=this.value"/>
          </div>
        </div>
        <div class="form-group full">
          <div class="range-wrap">
            <div class="range-top">
              <label>Area (Hectares)</label>
              <span class="range-val" id="area-val">50</span>
            </div>
            <input type="range" id="f-area" min="1" max="1000" value="50" step="1"
              oninput="document.getElementById('area-val').textContent=this.value"/>
          </div>
        </div>
      </div>
      <button class="predict-btn" id="predict-btn" onclick="runPredict()">‚ö° Predict Yield</button>

      <!-- FORECAST CHART -->
      <div id="forecast-box" class="forecast-box" style="display:none">
        <div class="flabel">üìà 5-Year Forecast</div>
        <div class="forecast-wrap"><canvas id="forecast-chart"></canvas></div>
      </div>
    </div>

    <!-- RESULT CARD -->
    <div class="glass-card fu result-panel" id="result-panel">
      <div class="placeholder">
        <div class="placeholder-icon">üå±</div>
        <div style="font-weight:700;font-size:1rem;color:var(--text)">Awaiting Prediction</div>
        <div style="font-size:.85rem">Configure your farm parameters and hit Predict</div>
      </div>
    </div>
  </div>
</section>

<!-- /PREDICT -->

<!-- CROP RECOMMENDER -->
<section id="recommend">
  <div class="section-label">AI Recommendation Engine</div>
  <div class="section-title">üå± Crop Recommender</div>
  <div class="section-sub">Based on your selected state, season, year, and area ‚Äî the AI ranks the best crops to plant by predicted yield.</div>
  <div style="text-align:center;margin-bottom:28px">
    <button class="btn-primary" onclick="loadRecommend()">ü§ñ Get AI Recommendations</button>
  </div>
  <div id="rec-loading" style="display:none"><div class="spinner"></div></div>
  <div id="rec-grid" class="rec-grid">
    <div class="placeholder" style="grid-column:1/-1;padding:50px">
      <div class="placeholder-icon">üå±</div>
      <div style="font-weight:700;color:var(--text)">Set parameters above and click Get AI Recommendations</div>
      <div style="font-size:.85rem;margin-top:6px">Uses your current State / Season / Year / Area inputs</div>
    </div>
  </div>
</section>

<!-- ANALYTICS DASHBOARD -->
<section id="analytics">
  <div class="section-title">üìä Analytics Dashboard</div>
  <div class="section-sub">Deep-dive into India's historical crop yield data across states, seasons, and decades.</div>

  <div class="tab-bar">
    <button class="tab active" onclick="switchTab('charts',this)">üìà Charts</button>
    <button class="tab" onclick="switchTab('shap',this)">üß† SHAP XAI</button>
    <button class="tab" onclick="switchTab('map',this);initMap()">üó∫Ô∏è India Map</button>
    <button class="tab" onclick="switchTab('batch',this)">üì¶ Batch Predict</button>
    <button class="tab" onclick="switchTab('compare',this);initCompare()">‚öñÔ∏è Compare Crops</button>
  </div>

  <div class="tab-pane active" id="pane-charts">
    <!-- Dynamic chart filter bar -->
    <div style="display:flex;align-items:center;gap:14px;margin-bottom:24px;padding:14px 20px;background:var(--glass);border:1px solid var(--glass-border);border-radius:16px;flex-wrap:wrap">
      <span style="font-size:.76rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;white-space:nowrap">üîç Filter Charts</span>
      <select id="cf-state" onchange="applyChartFilters()" style="flex:1;min-width:160px;background:#0d1b2a;border:1px solid var(--glass-border);color:var(--text);padding:8px 14px;border-radius:10px;font-family:inherit;font-size:.84rem;outline:none;cursor:pointer;transition:border-color .2s" onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--glass-border)'">
        <option value="">üåç All States</option>
      </select>
      <select id="cf-crop" onchange="applyChartFilters()" style="flex:1;min-width:160px;background:#0d1b2a;border:1px solid var(--glass-border);color:var(--text);padding:8px 14px;border-radius:10px;font-family:inherit;font-size:.84rem;outline:none;cursor:pointer;transition:border-color .2s" onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--glass-border)'">
        <option value="">üåæ All Crops</option>
      </select>
      <span id="chart-filter-badge" style="display:none;font-size:.72rem;font-weight:700;padding:5px 13px;background:rgba(0,229,160,.12);border:1px solid rgba(0,229,160,.3);border-radius:999px;color:var(--accent);white-space:nowrap"></span>
      <button id="chart-reset-btn" onclick="resetChartFilters()" style="display:none;padding:8px 16px;background:transparent;border:1px solid var(--glass-border);color:var(--muted);border-radius:10px;font-family:inherit;font-size:.82rem;cursor:pointer;transition:.2s;white-space:nowrap" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--glass-border)';this.style.color='var(--muted)'">‚Ü∫ Global View</button>
    </div>
    <div class="charts-grid">
      <div class="chart-card fu">
        <h3 id="chart-title-topcrop">üèÜ Top 10 Crops by Avg Yield</h3>
        <div class="chart-area"><canvas id="chart-topcrop"></canvas></div>
      </div>
      <div class="chart-card fu">
        <h3 id="chart-title-season">üå§Ô∏è Season-wise Yield (Mean vs Median)</h3>
        <div class="chart-area"><canvas id="chart-season"></canvas></div>
      </div>
      <div class="chart-card fu" style="grid-column:1/-1">
        <h3 id="chart-title-trend">üìÖ Yearly Average Yield Trend</h3>
        <div class="chart-area" style="height:220px"><canvas id="chart-trend"></canvas></div>
      </div>
      <div class="chart-card fu" style="grid-column:1/-1">
        <h3 id="chart-title-state">üó∫Ô∏è Top 25 States by Avg Yield</h3>
        <div class="chart-area tall"><canvas id="chart-state"></canvas></div>
      </div>
    </div>
  </div>

  <div class="tab-pane" id="pane-shap">
    <div class="glass-card fu">
      <div style="font-size:1.05rem;font-weight:700;margin-bottom:8px">üß† SHAP Feature Importance</div>
      <div class="shap-info">
        SHAP (SHapley Additive exPlanations) breaks down how each input feature
        pushes the model's prediction up or down from the baseline.
        <b style="color:var(--accent)">Green bars</b> increase yield,
        <b style="color:#f87171">red bars</b> decrease it.
        Run a prediction first to see live SHAP values.
      </div>
      <div id="shap-content">
        <div class="placeholder" style="padding:48px">
          <div class="placeholder-icon">üß¨</div>
          <div style="font-weight:700;color:var(--text)">Run a prediction to see SHAP values</div>
          <div style="font-size:.85rem">Go to the Predict section above first</div>
        </div>
      </div>
    </div>
  </div>

  <div class="tab-pane" id="pane-map">
    <div class="glass-card fu">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px">
        <div>
          <div style="font-size:1.05rem;font-weight:700;margin-bottom:6px">üó∫Ô∏è India State Yield Choropleth</div>
          <div style="font-size:.83rem;color:var(--muted)">Average yield (T/Ha) per state. Hover a state for details. Click to filter.</div>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <select id="map-metric" onchange="refreshMap()"
            style="background:rgba(255,255,255,.06);border:1px solid var(--glass-border);
            color:var(--text);padding:9px 14px;border-radius:10px;font-family:inherit;
            font-size:.83rem;outline:none;cursor:pointer">
            <option value="avg">Avg Yield (all crops)</option>
            <option value="filtered">Filtered by prediction params</option>
          </select>
        </div>
      </div>
      <div id="india-map"></div>
      <div id="map-selected-info" style="margin-top:14px;font-size:.82rem;color:var(--muted);text-align:center">
        Hover over a state to see details
      </div>
    </div>
  </div>

  <!-- BATCH PREDICT TAB -->
  <div class="tab-pane" id="pane-batch">
    <div class="glass-card fu">
      <div style="font-size:1.05rem;font-weight:700;margin-bottom:6px">üì¶ Batch Predict ‚Äî CSV Style Input</div>
      <div style="font-size:.83rem;color:var(--muted);margin-bottom:18px;line-height:1.7">
        Enter one row per line: <code style="color:var(--accent);background:rgba(0,229,160,.08);padding:2px 7px;border-radius:6px">State, Season, Crop, Year, Area</code>
        <br/>Example: <span style="color:var(--muted);font-family:monospace">Kerala, Kharif     , Rice, 2024, 500</span>
      </div>
      <textarea class="batch-area" id="batch-input" placeholder="Kerala, Kharif     , Rice, 2024, 500
Andhra Pradesh, Rabi   , Wheat, 2024, 200
Punjab, Whole Year     , Maize, 2024, 300"></textarea>
      <div style="display:flex;gap:12px;margin-top:14px;flex-wrap:wrap">
        <button class="btn-primary" style="padding:12px 28px;font-size:.9rem" onclick="runBatchPredict()">‚ö° Run Batch Predict</button>
        <button class="btn-ghost" style="padding:12px 24px;font-size:.9rem" onclick="document.getElementById('batch-input').value=''">‚úï Clear</button>
      </div>
      <div id="batch-status" style="margin-top:14px;font-size:.85rem;color:var(--accent)"></div>
      <div id="batch-results" class="batch-results" style="margin-top:12px;overflow-x:auto">
        <table style="width:100%;border-collapse:collapse;display:none" id="batch-table">
          <thead><tr style="color:var(--muted);font-size:.78rem;text-align:left">
            <th style="padding:8px">State</th><th>Season</th><th>Crop</th>
            <th>Year</th><th>Area</th>
            <th style="color:var(--accent)">Yield T/Ha</th><th>Production</th>
          </tr></thead>
          <tbody id="batch-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- CROP COMPARE TAB -->
  <div class="tab-pane" id="pane-compare">
    <div class="glass-card fu">
      <div style="font-size:1.05rem;font-weight:700;margin-bottom:6px">‚öñÔ∏è Crop Comparison</div>
      <div style="font-size:.83rem;color:var(--muted);margin-bottom:18px">Compare predicted yield for multiple crops using your current State / Season / Year / Area inputs. Add up to 5 crops.</div>
      <div class="cmp-inputs">
        <select id="compare-crop-select" class="cmp-select"><option>Loading‚Ä¶</option></select>
        <button class="cmp-add-btn" onclick="addCropToCompare()">+ Add Crop</button>
        <button class="btn-primary" style="padding:9px 22px;font-size:.85rem" onclick="runCompare()">‚öñÔ∏è Compare</button>
      </div>
      <div id="compare-chips" class="cmp-inputs" style="margin-bottom:0"></div>
      <div id="compare-result" style="margin-top:20px"></div>
    </div>
  </div>
</section>
<section id="contextual" style="display:none">
  <div class="section-label">Contextual Intelligence</div>
  <div class="section-title">üìç Analysis for Your Prediction</div>
  <div class="section-sub" id="ctx-sub">Showing data filtered by your selected parameters.</div>

  <div class="ctx-stats" id="ctx-stats"></div>

  <div class="ctx-charts">
    <div class="chart-card fu">
      <h3 id="ctx-chart1-title">Top Crops in Selected State</h3>
      <div class="chart-area"><canvas id="ctx-chart1"></canvas></div>
    </div>
    <div class="chart-card fu">
      <h3 id="ctx-chart2-title">Season Distribution for Selected State</h3>
      <div class="chart-area"><canvas id="ctx-chart2"></canvas></div>
    </div>
    <div class="chart-card fu" style="grid-column:1/-1">
      <h3 id="ctx-chart3-title">Yearly Trend for Selected Crop</h3>
      <div class="chart-area" style="height:220px"><canvas id="ctx-chart3"></canvas></div>
    </div>
    <div class="chart-card fu" style="grid-column:1/-1">
      <h3 id="ctx-chart4-title">Top States for Selected Crop</h3>
      <div class="chart-area" style="height:260px"><canvas id="ctx-chart4"></canvas></div>
    </div>
  </div>
</section>

<!-- DATA EXPLORER -->
<section id="data">
  <div class="section-label">Raw Dataset</div>
  <div class="section-title">üîç Data Explorer</div>
  <div class="section-sub">Live sample of the underlying crop production dataset. Refresh for a new random sample.</div>
  <div class="glass-card fu">
    <div class="tbl-toolbar">
      <input class="tbl-search" id="tbl-search" placeholder="Filter by state, crop, season, district‚Ä¶" oninput="filterTable()"/>
      <button class="tbl-refresh" onclick="loadTable()">‚Ü∫ New Sample</button>
    </div>
    <div class="tbl-wrap">
      <table>
        <thead><tr>
          <th>State</th><th>District</th><th>Year</th>
          <th>Season</th><th>Crop</th>
          <th>Area (Ha)</th><th>Production</th><th>Yield (T/Ha)</th>
        </tr></thead>
        <tbody id="tbl-body">
          <tr><td colspan="8"><div class="spinner"></div></td></tr>
        </tbody>
      </table>
    </div>
    <div class="tbl-foot">
      <span id="tbl-count">Loading‚Ä¶</span>
      <span style="color:var(--accent);font-weight:600">Showing random sample of 200</span>
    </div>
  </div>
</section>

<footer>
  <div style="font-size:1.3rem;margin-bottom:8px">üåæ</div>
  <span class="accent">AgriYield AI</span> &nbsp;¬∑&nbsp;
  FastAPI + Three.js + Chart.js &nbsp;¬∑&nbsp;
  Model: <span class="accent">RandomForestRegressor</span> &nbsp;¬∑&nbsp;
  XAI: <span class="accent">SHAP</span><br/>
  <span style="font-size:.78rem">Dataset: 246,000+ Indian crop production records</span>
</footer>
</div>

<!-- HISTORY SIDEPANEL -->
<div class="hist-overlay" id="hist-overlay" onclick="toggleHistory()"></div>
<div id="history-panel">
  <div class="hist-header">
    <div class="hist-title">üìã Prediction History</div>
    <button class="hist-close" onclick="toggleHistory()">√ó</button>
  </div>
  <div id="hist-items">
    <div class="placeholder" style="padding:40px 0">
      <div class="placeholder-icon">üìä</div>
      <div style="font-weight:600;color:var(--muted);font-size:.88rem">No predictions yet</div>
    </div>
  </div>
  <div style="margin-top:20px">
    <button onclick="clearHistory()"
      style="width:100%;padding:12px;background:transparent;border:1px solid rgba(248,113,113,.3);
      color:#f87171;border-radius:12px;font-family:inherit;font-size:.84rem;cursor:pointer;transition:.2s"
      onmouseover="this.style.background='rgba(248,113,113,.07)'"
      onmouseout="this.style.background='transparent'">
      üóëÔ∏è Clear All History
    </button>
  </div>
</div>

<div id="toast"></div>

<script>
// Auto-detect environment
const API = (location.hostname === "localhost" || location.hostname === "127.0.0.1")
  ? "http://localhost:8000"
  : "";  // same-origin on HuggingFace Spaces
let tableData = [];
let forecastInst = null;
let chartsLoaded = false;
let mainCharts={topcrop:null,season:null,trend:null,state:null};

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ
function nav(id){document.getElementById(id)?.scrollIntoView({behavior:'smooth',block:'start'})}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
function toast(msg, type='success', dur=3500){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = type==='error' ? 'show error' : 'show';
  clearTimeout(t._t);
  t._t = setTimeout(()=>t.className='', dur);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  THREE.JS 3D PARTICLE UNIVERSE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let targetTint = null; // set after THREE loads
(function(){
  const canvas = document.getElementById('bg-canvas');
  const renderer = new THREE.WebGLRenderer({canvas, alpha:true, antialias:true});
  renderer.setPixelRatio(Math.min(devicePixelRatio,2));
  renderer.setSize(innerWidth, innerHeight);

  const scene = new THREE.Scene();
  const cam = new THREE.PerspectiveCamera(55, innerWidth/innerHeight, 0.1, 1000);
  cam.position.z = 90;

  // ‚îÄ‚îÄ PARTICLES ‚îÄ‚îÄ
  const N = 4000;
  const geo = new THREE.BufferGeometry();
  const pos = new Float32Array(N*3);
  const col = new Float32Array(N*3);
  const sizes = new Float32Array(N);
  const c1=new THREE.Color('#00e5a0'), c2=new THREE.Color('#0ea5e9'), c3=new THREE.Color('#a78bfa');
  for(let i=0;i<N;i++){
    const r=60+Math.random()*100, theta=Math.random()*Math.PI*2, phi=Math.acos(2*Math.random()-1);
    pos[i*3]   = r*Math.sin(phi)*Math.cos(theta);
    pos[i*3+1] = r*Math.sin(phi)*Math.sin(theta);
    pos[i*3+2] = r*Math.cos(phi);
    const t=Math.random(), mix=Math.random();
    const c = mix<.5 ? c1.clone().lerp(c2,t) : c2.clone().lerp(c3,t);
    col[i*3]=c.r; col[i*3+1]=c.g; col[i*3+2]=c.b;
    sizes[i] = .3+Math.random()*1.2;
  }
  geo.setAttribute('position',new THREE.BufferAttribute(pos,3));
  geo.setAttribute('color',   new THREE.BufferAttribute(col,3));
  const mat = new THREE.PointsMaterial({size:.7,vertexColors:true,transparent:true,opacity:.5,sizeAttenuation:true});
  const pts = new THREE.Points(geo, mat);
  scene.add(pts);

  // ‚îÄ‚îÄ tint control ‚îÄ‚îÄ
  const tintColor = new THREE.Color(1,1,1);
  targetTint = tintColor; // expose to outer scope
  window.bgControl = {
    setTint: hex => { tintColor.set(hex); }
  };

  // ‚îÄ‚îÄ INNER CORE GLOW SPHERE ‚îÄ‚îÄ
  const coreMat = new THREE.MeshBasicMaterial({
    color:0x00e5a0, transparent:true, opacity:.03, wireframe:true});
  scene.add(new THREE.Mesh(new THREE.SphereGeometry(28,24,24), coreMat));

  // ‚îÄ‚îÄ GRID LINES ‚îÄ‚îÄ
  const gridMat = new THREE.LineBasicMaterial({color:0x0ea5e9,transparent:true,opacity:.04});
  for(let i=0;i<20;i++){
    const ag = new THREE.BufferGeometry().setFromPoints([
      new THREE.Vector3((Math.random()-.5)*200,(Math.random()-.5)*200,(Math.random()-.5)*200),
      new THREE.Vector3((Math.random()-.5)*200,(Math.random()-.5)*200,(Math.random()-.5)*200),
    ]);
    scene.add(new THREE.Line(ag,gridMat));
  }

  let mx=0,my=0,tx=0,ty=0;
  document.addEventListener('mousemove',e=>{
    mx=(e.clientX/innerWidth-.5)*2;
    my=(e.clientY/innerHeight-.5)*2;
  });
  addEventListener('resize',()=>{
    cam.aspect=innerWidth/innerHeight;
    cam.updateProjectionMatrix();
    renderer.setSize(innerWidth,innerHeight);
  });

  let tick=0;
  (function loop(){
    requestAnimationFrame(loop);
    tick+=.002;
    tx+=(mx-tx)*.04; ty+=(my-ty)*.04;
    pts.rotation.y = tick*.12+tx*.08;
    pts.rotation.x = tick*.06+ty*.06;
    coreMat.opacity = .02+Math.sin(tick*2)*.015;
    // smooth tint lerp
    mat.color.lerp(tintColor, .016);
    // subtle wave on particles
    const p=geo.attributes.position.array;
    for(let i=1;i<N*3;i+=9){p[i]+=Math.sin(tick*1.5+p[i-1]*.02)*.006;}
    geo.attributes.position.needsUpdate=true;
    renderer.render(scene,cam);
  })();
})();

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  GSAP SCROLL ANIMATIONS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initAnimations(){
  const io = new IntersectionObserver(entries=>{
    entries.forEach(e=>{
      if(e.isIntersecting){
        const siblings=[...e.target.parentElement.children];
        const idx=siblings.filter(s=>s.classList.contains('fu')).indexOf(e.target);
        gsap.to(e.target,{opacity:1,y:0,duration:.75,ease:'power3.out',delay:idx*.08});
        io.unobserve(e.target);
      }
    });
  },{threshold:.1});
  document.querySelectorAll('.fu').forEach(el=>io.observe(el));
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  META & STATS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  WEATHER CANVAS SYSTEM  (storm / blizzard / embers)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
class WeatherSystem {
  constructor(){
    this.canvas = document.getElementById('weather-canvas');
    this.ctx = this.canvas ? this.canvas.getContext('2d') : null;
    this.particles = []; this.type = null; this.raf = null; this._tick = 0;
    this._lightning = {active:false,alpha:0,next:140,bolts:[]};
    this._gustPhase = 0; this._ripples = []; this._snowDrift = [];
    if(this.canvas) this._resize();
    window.addEventListener('resize', ()=>this._resize());
  }
  _resize(){ if(!this.canvas) return; this.canvas.width=innerWidth; this.canvas.height=innerHeight; }
  setType(type){
    this.type=type; this.particles=[]; this._tick=0;
    this._lightning={active:false,alpha:0,next:140,bolts:[]}; this._ripples=[]; this._snowDrift=[];
    cancelAnimationFrame(this.raf);
    if(!type||!this.ctx){ if(this.canvas) this.canvas.classList.remove('wx-active'); return; }
    this.canvas.classList.add('wx-active');
    const count=type==='rain'?280:type==='snow'?180:90;
    for(let i=0;i<count;i++) this._spawn(true);
    this._loop();
  }
  _spawn(init){
    const t=this.type;
    if(t==='rain'){
      this.particles.push({x:Math.random()*innerWidth, y:init?Math.random()*innerHeight:-30,
        len:16+Math.random()*22, speed:14+Math.random()*10, drift:2.5+Math.random()*3,
        opacity:0.25+Math.random()*0.45, thick:0.8+Math.random()*0.8});
    } else if(t==='snow'){
      const big=Math.random()<0.2;
      this.particles.push({x:Math.random()*innerWidth, y:init?Math.random()*innerHeight:-10,
        size:big?3.5+Math.random()*2:1.2+Math.random()*1.8, speed:big?0.8+Math.random()*0.6:0.4+Math.random()*1.1,
        drift:(Math.random()-.5)*0.7, wave:Math.random()*Math.PI*2, waveSpd:0.01+Math.random()*0.02,
        opacity:big?0.65+Math.random()*0.3:0.3+Math.random()*0.55});
    } else if(t==='embers'){
      this.particles.push({x:Math.random()*innerWidth, y:innerHeight+Math.random()*100,
        size:1.5+Math.random()*3, speed:0.6+Math.random()*1.4, drift:(Math.random()-.5)*1.2,
        wave:Math.random()*Math.PI*2, waveSpd:0.02+Math.random()*0.04,
        opacity:0.4+Math.random()*0.5, flicker:Math.random()*Math.PI*2, flickerSpd:0.08+Math.random()*0.12,
        hue:15+Math.random()*30});
    }
  }
  _buildBolt(x1,y1,x2,y2,d){
    if(d===0) return [[x1,y1,x2,y2]];
    const mx=(x1+x2)/2+(Math.random()-.5)*(Math.abs(x2-x1)+60)*0.6;
    const my=(y1+y2)/2+(Math.random()-.5)*Math.abs(y2-y1)*0.35;
    return [...this._buildBolt(x1,y1,mx,my,d-1),...this._buildBolt(mx,my,x2,y2,d-1)];
  }
  _triggerLightning(){
    const lx=innerWidth*0.1+Math.random()*innerWidth*0.8;
    const segs=this._buildBolt(lx,0,lx+(Math.random()-.5)*innerWidth*0.28,innerHeight*0.78,5);
    const bp=segs[Math.floor(segs.length*0.4)];
    const b2=this._buildBolt(bp[2],bp[3],bp[2]+(Math.random()-.5)*200,bp[3]+innerHeight*0.22,3);
    const b3=this._buildBolt(bp[2],bp[3],bp[2]+(Math.random()-.5)*150,bp[3]+innerHeight*0.15,2);
    this._lightning={active:true,alpha:1.0,next:180+Math.floor(Math.random()*280),bolts:[segs,b2,b3]};
  }
  _loop(){
    const ctx=this.ctx, t=this.type; ctx.clearRect(0,0,innerWidth,innerHeight);
    this._tick++; this._gustPhase+=0.0038;

    if(t==='rain'){
      // Top sheet tint
      const rt=ctx.createLinearGradient(0,0,0,innerHeight*0.38);
      rt.addColorStop(0,'rgba(8,16,36,0.10)'); rt.addColorStop(1,'rgba(8,16,36,0)');
      ctx.fillStyle=rt; ctx.fillRect(0,0,innerWidth,innerHeight*0.38);
      const gX=Math.sin(this._gustPhase)*1.9;
      this.particles.forEach(p=>{
        ctx.save(); ctx.globalAlpha=p.opacity;
        const ex=p.x+(p.drift+gX)*0.7, ey=p.y+p.len;
        const g=ctx.createLinearGradient(p.x,p.y,ex,ey);
        g.addColorStop(0,'rgba(180,225,255,0)'); g.addColorStop(0.4,'rgba(180,225,255,0.85)'); g.addColorStop(1,'rgba(140,200,255,0.55)');
        ctx.strokeStyle=g; ctx.lineWidth=p.thick;
        ctx.beginPath(); ctx.moveTo(p.x,p.y); ctx.lineTo(ex,ey); ctx.stroke(); ctx.restore();
        p.y+=p.speed; p.x+=p.drift+gX*0.4;
        if(p.y>innerHeight+30||p.x<-40||p.x>innerWidth+40)
          Object.assign(p,{x:Math.random()*innerWidth,y:-20,len:16+Math.random()*22,speed:14+Math.random()*10,drift:2.5+Math.random()*3,opacity:0.25+Math.random()*0.45,thick:0.8+Math.random()*0.8});
      });
      // Splash ripples
      if(this._tick%4===0 && this._ripples.length<22)
        this._ripples.push({x:Math.random()*innerWidth,y:innerHeight-2,r:0,max:12+Math.random()*18,op:0.45});
      this._ripples.forEach((rp,i)=>{
        ctx.save(); ctx.globalAlpha=rp.op*(1-rp.r/rp.max);
        ctx.strokeStyle='rgba(150,210,255,0.7)'; ctx.lineWidth=0.8;
        ctx.beginPath(); ctx.ellipse(rp.x,rp.y,rp.r,rp.r*0.33,0,0,Math.PI*2); ctx.stroke(); ctx.restore();
        rp.r+=0.7; if(rp.r>rp.max) this._ripples.splice(i,1);
      });
      // Lightning
      const L=this._lightning;
      if(L.active){
        ctx.save(); ctx.globalAlpha=L.alpha*0.13; ctx.fillStyle='#b0d4ff'; ctx.fillRect(0,0,innerWidth,innerHeight); ctx.restore();
        L.bolts.forEach((segs,bi)=>{
          ctx.save(); ctx.shadowBlur=bi===0?20:9; ctx.shadowColor='#99d4ff';
          ctx.globalAlpha=bi===0?L.alpha:L.alpha*(0.5-bi*0.15);
          ctx.strokeStyle=bi===0?'#ddeeff':'rgba(180,220,255,0.9)'; ctx.lineWidth=bi===0?2.5:bi===1?1.2:0.8; ctx.lineCap='round';
          ctx.beginPath(); segs.forEach((s,k)=>{ if(k===0)ctx.moveTo(s[0],s[1]); ctx.lineTo(s[2],s[3]); }); ctx.stroke(); ctx.restore();
        });
        L.alpha-=0.042; if(L.alpha<=0) L.active=false;
      } else { L.next--; if(L.next<=0) this._triggerLightning(); }
    }

    else if(t==='snow'){
      const gX=Math.sin(this._gustPhase*2.5)*2.3+Math.sin(this._gustPhase*0.7)*1.1;
      this.particles.forEach(p=>{
        p.wave+=p.waveSpd;
        const wx=p.x+Math.sin(p.wave)*4.5+gX;
        ctx.save(); ctx.globalAlpha=p.opacity;
        ctx.fillStyle='rgba(220,235,255,0.9)';
        ctx.shadowBlur=p.size<2.5?0:4; ctx.shadowColor='rgba(200,220,255,0.5)';
        ctx.beginPath(); ctx.arc(wx,p.y,p.size,0,Math.PI*2); ctx.fill(); ctx.restore();
        p.y+=p.speed; p.x+=p.drift+gX*0.25;
        if(p.y>innerHeight+15||p.x<-30||p.x>innerWidth+30){
          const big=Math.random()<0.2;
          Object.assign(p,{x:Math.random()*innerWidth,y:-10,size:big?3.5+Math.random()*2:1.2+Math.random()*1.8,
            speed:big?0.8+Math.random()*0.6:0.4+Math.random()*1,drift:(Math.random()-.5)*0.7,wave:Math.random()*Math.PI*2,opacity:big?0.65+Math.random()*0.3:0.3+Math.random()*0.5});
        }
      });
      if(this._tick%3===0 && this._snowDrift.length<8)
        this._snowDrift.push({x:-70,y:innerHeight-8-Math.random()*18,w:70+Math.random()*110,op:0.16+Math.random()*0.18,spd:1.5+Math.random()*1.3});
      this._snowDrift.forEach((d,i)=>{
        ctx.save(); ctx.globalAlpha=d.op;
        const dg=ctx.createLinearGradient(d.x,d.y,d.x+d.w,d.y);
        dg.addColorStop(0,'rgba(220,235,255,0)'); dg.addColorStop(0.5,'rgba(220,235,255,0.9)'); dg.addColorStop(1,'rgba(220,235,255,0)');
        ctx.fillStyle=dg; ctx.beginPath(); ctx.ellipse(d.x+d.w/2,d.y,d.w/2,4,0,0,Math.PI*2); ctx.fill(); ctx.restore();
        d.x+=d.spd; if(d.x>innerWidth+90) this._snowDrift.splice(i,1);
      });
    }

    else if(t==='embers'){
      this.particles.forEach(p=>{
        p.wave+=p.waveSpd; p.flicker+=p.flickerSpd;
        const wx=p.x+Math.sin(p.wave)*8, glow=0.5+Math.sin(p.flicker)*0.45;
        ctx.save(); ctx.globalAlpha=p.opacity*glow;
        const eg=ctx.createRadialGradient(wx,p.y,0,wx,p.y,p.size*2.5);
        eg.addColorStop(0,'rgba(255,255,180,0.95)');
        eg.addColorStop(0.3,`hsla(${p.hue},100%,55%,0.85)`);
        eg.addColorStop(1,`hsla(${p.hue},80%,30%,0)`);
        ctx.fillStyle=eg; ctx.beginPath(); ctx.arc(wx,p.y,p.size*2.5,0,Math.PI*2); ctx.fill(); ctx.restore();
        p.y-=p.speed; p.x+=p.drift; p.opacity-=0.0008;
        if(p.y<-20||p.opacity<0.05||p.x<-20||p.x>innerWidth+20)
          Object.assign(p,{x:Math.random()*innerWidth,y:innerHeight+10,size:1.5+Math.random()*3,speed:0.6+Math.random()*1.4,
            drift:(Math.random()-.5)*1.2,wave:Math.random()*Math.PI*2,waveSpd:0.02+Math.random()*0.04,
            opacity:0.4+Math.random()*0.5,flicker:Math.random()*Math.PI*2,flickerSpd:0.08+Math.random()*0.12,hue:15+Math.random()*30});
      });
    }
    this.raf=requestAnimationFrame(()=>this._loop());
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  SEASON OVERLAY ‚Äî Storm/Wheat/Sun/Leaves/Aurora
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
class SeasonOverlay {
  constructor(){
    this.canvas = document.getElementById('season-overlay');
    this.ctx = this.canvas ? this.canvas.getContext('2d') : null;
    this.type = null; this.particles = []; this.tick = 0; this.raf = null;
    this._clouds = null; this._lightning = {active:false,alpha:0,next:100,bolts:[]};
    this._ripples = []; this._windGusts = []; this._vortexes = [];
    this._lensFlares = null; this._snowDrift = []; this._windLines = null; this._gustLines = null;
    if(this.canvas) this._resize();
    window.addEventListener('resize', ()=>this._resize());
  }
  _resize(){ if(!this.canvas) return; this.canvas.width=innerWidth; this.canvas.height=innerHeight; }
  setType(type){
    cancelAnimationFrame(this.raf);
    this.type=type; this.particles=[]; this.tick=0;
    this._clouds=null; this._lightning={active:false,alpha:0,next:100,bolts:[]};
    this._ripples=[]; this._windGusts=[]; this._vortexes=[]; this._lensFlares=null;
    this._snowDrift=[]; this._windLines=null; this._gustLines=null;
    if(!this.canvas||!this.ctx) return;
    if(!type||type==='whole'){ this.canvas.classList.remove('sx-active'); return; }
    this.canvas.classList.add('sx-active');
    const counts={autumn:52, summer:40, rabi:72, kharif:0, winter:40};
    for(let i=0;i<(counts[type]||0);i++) this._spawn(true);
    if(type==='kharif')   this._initClouds();
    if(type==='summer')   this._lensFlares=this._buildLensFlares();
    if(type==='autumn')   for(let j=0;j<2;j++) this._vortexes.push({x:innerWidth*(0.2+j*0.55),y:innerHeight*(0.3+Math.random()*0.3),phase:Math.random()*Math.PI*2,life:500+Math.random()*500});
    this._loop();
  }
  _initClouds(){
    this._clouds=Array.from({length:9},(_,i)=>({
      x:Math.random()*innerWidth, y:18+i*24+Math.random()*16,
      spd:0.20+Math.random()*0.35, size:58+Math.random()*85,
      op:0.30+Math.random()*0.32, dark:0.38+Math.random()*0.42
    }));
  }
  _buildLensFlares(){
    const cx=innerWidth*0.87, cy=innerHeight*0.10;
    return [{dx:-.15,dy:.12,r:12,op:.18,c:'rgba(255,200,80,'},{dx:-.30,dy:.25,r:28,op:.09,c:'rgba(255,220,100,'},
      {dx:-.50,dy:.42,r:7,op:.14,c:'rgba(255,255,200,'},{dx:-.65,dy:.55,r:38,op:.07,c:'rgba(255,180,60,'},
      {dx:-.80,dy:.68,r:14,op:.11,c:'rgba(253,224,71,'}].map(f=>({...f,x:cx+innerWidth*f.dx,y:cy+innerHeight*f.dy}));
  }
  _buildBolt(x1,y1,x2,y2,d){
    if(d===0) return [[x1,y1,x2,y2]];
    const mx=(x1+x2)/2+(Math.random()-.5)*(Math.abs(x2-x1)+60)*0.6;
    const my=(y1+y2)/2+(Math.random()-.5)*Math.abs(y2-y1)*0.35;
    return [...this._buildBolt(x1,y1,mx,my,d-1),...this._buildBolt(mx,my,x2,y2,d-1)];
  }
  _triggerLightning(){
    const lx=innerWidth*0.1+Math.random()*innerWidth*0.8;
    const s=this._buildBolt(lx,0,lx+(Math.random()-.5)*innerWidth*0.28,innerHeight*0.76,5);
    const bp=s[Math.floor(s.length*0.4)];
    const b2=this._buildBolt(bp[2],bp[3],bp[2]+(Math.random()-.5)*200,bp[3]+innerHeight*0.22,3);
    const b3=this._buildBolt(bp[2],bp[3],bp[2]+(Math.random()-.5)*140,bp[3]+innerHeight*0.14,2);
    this._lightning={active:true,alpha:1.0,next:190+Math.floor(Math.random()*270),bolts:[s,b2,b3]};
  }
  _spawn(init){
    const t=this.type;
    if(t==='autumn'){
      const types=['maple','oak','ellipse'];
      this.particles.push({x:Math.random()*innerWidth, y:init?Math.random()*innerHeight:-30,
        size:7+Math.random()*11, speed:0.5+Math.random()*1.1, drift:(Math.random()-.5)*1.6,
        rot:Math.random()*Math.PI*2, rotSpeed:(Math.random()-.5)*0.055,
        color:['#fb923c','#ea580c','#ef4444','#f59e0b','#dc2626','#b45309','#d97706'][Math.floor(Math.random()*7)],
        opacity:0.5+Math.random()*0.45, swing:Math.random()*Math.PI*2, swingSpd:0.014+Math.random()*0.022,
        leafType:types[Math.floor(Math.random()*3)]});
    } else if(t==='summer'){
      this.particles.push({x:Math.random()*innerWidth, y:innerHeight*(0.44+Math.random()*0.53),
        size:1.8+Math.random()*3.2, speed:0.18+Math.random()*0.52, drift:(Math.random()-.5)*0.5,
        wave:Math.random()*Math.PI*2, waveSpd:0.014+Math.random()*0.024, opacity:0.07+Math.random()*0.17});
    } else if(t==='rabi'){
      const isSeed=Math.random()<0.35;
      this.particles.push({x:Math.random()*innerWidth, y:init?Math.random()*innerHeight:innerHeight+10,
        size:isSeed?2.2+Math.random()*2:1+Math.random()*1.8, speed:isSeed?0.28+Math.random()*0.55:0.14+Math.random()*0.42,
        drift:(Math.random()-.5)*(isSeed?0.9:0.5)+0.28,
        wave:Math.random()*Math.PI*2, waveSpd:0.007+Math.random()*0.014,
        opacity:isSeed?0.4+Math.random()*0.45:0.22+Math.random()*0.32, isSeed});
    } else if(t==='winter'){
      this.particles.push({x:Math.random()*innerWidth, y:init?Math.random()*innerHeight:-20,
        size:4+Math.random()*9, speed:0.14+Math.random()*0.38, drift:(Math.random()-.5)*0.55,
        rot:Math.random()*Math.PI*2, rotSpeed:(Math.random()-.5)*0.007,
        wave:Math.random()*Math.PI*2, waveSpd:0.005+Math.random()*0.009, opacity:0.35+Math.random()*0.55});
    }
  }

  // ‚îÄ‚îÄ Kharif: dark storm clouds + forked lightning + rain ripples ‚îÄ‚îÄ
  _drawStormClouds(){
    const ctx=this.ctx, k=this.tick, W=innerWidth, H=innerHeight;
    const tg=ctx.createLinearGradient(0,0,0,H*0.48);
    tg.addColorStop(0,'rgba(4,7,20,0.42)'); tg.addColorStop(1,'rgba(4,7,20,0)');
    ctx.fillStyle=tg; ctx.fillRect(0,0,W,H*0.48);
    if(!this._clouds) this._initClouds();
    this._clouds.forEach(c=>{
      const s=c.size, pulse=Math.sin(k*0.004+c.dark*3)*0.03;
      const dr=Math.floor(18+c.dark*22), dg=Math.floor(20+c.dark*25), db=Math.floor(42+c.dark*38);
      ctx.save(); ctx.globalAlpha=c.op+pulse;
      ctx.fillStyle=`rgb(${dr},${dg},${db})`;
      ctx.shadowBlur=22; ctx.shadowColor='rgba(8,12,45,0.9)';
      ctx.beginPath();
      ctx.arc(c.x,       c.y,       s*.52,0,Math.PI*2);
      ctx.arc(c.x+s*.42, c.y-s*.20, s*.40,0,Math.PI*2);
      ctx.arc(c.x-s*.38, c.y-s*.14, s*.34,0,Math.PI*2);
      ctx.arc(c.x+s*.70, c.y+s*.04, s*.29,0,Math.PI*2);
      ctx.arc(c.x-s*.14, c.y-s*.38, s*.26,0,Math.PI*2);
      ctx.fill(); ctx.restore();
      c.x+=c.spd; if(c.x>W+s*1.5) c.x=-s*2;
    });
    // Lightning
    const L=this._lightning;
    if(L.active){
      ctx.save(); ctx.globalAlpha=L.alpha*0.16; ctx.fillStyle='#b8cfff'; ctx.fillRect(0,0,W,H); ctx.restore();
      L.bolts.forEach((segs,bi)=>{
        ctx.save(); ctx.shadowBlur=bi===0?24:11; ctx.shadowColor='#9dceff';
        ctx.globalAlpha=bi===0?L.alpha:L.alpha*(0.52-bi*0.17);
        ctx.strokeStyle=bi===0?'#e0eeff':'rgba(180,220,255,0.9)';
        ctx.lineWidth=bi===0?2.6:bi===1?1.3:0.9; ctx.lineCap='round';
        ctx.beginPath(); segs.forEach((s,j)=>{ if(j===0)ctx.moveTo(s[0],s[1]); ctx.lineTo(s[2],s[3]); }); ctx.stroke(); ctx.restore();
      });
      L.alpha-=0.036; if(L.alpha<=0) L.active=false;
    } else { L.next--; if(L.next<=0) this._triggerLightning(); }
    // Splash ripples
    if(k%3===0 && this._ripples.length<28)
      this._ripples.push({x:Math.random()*W,y:H-3,r:0,max:11+Math.random()*17,op:0.42});
    this._ripples.forEach((rp,i)=>{
      ctx.save(); ctx.globalAlpha=rp.op*(1-rp.r/rp.max);
      ctx.strokeStyle='rgba(140,200,255,0.65)'; ctx.lineWidth=0.9;
      ctx.beginPath(); ctx.ellipse(rp.x,rp.y,rp.r,rp.r*0.32,0,0,Math.PI*2); ctx.stroke(); ctx.restore();
      rp.r+=0.68; if(rp.r>rp.max) this._ripples.splice(i,1);
    });
  }

  // ‚îÄ‚îÄ Rabi: swaying wheat + mist + wind lines ‚îÄ‚îÄ
  _drawWheatField(){
    const ctx=this.ctx, k=this.tick, W=innerWidth, H=innerHeight;
    const mist=ctx.createLinearGradient(0,H*0.72,0,H);
    mist.addColorStop(0,'rgba(190,224,105,0)'); mist.addColorStop(0.65,'rgba(200,230,130,0.055)'); mist.addColorStop(1,'rgba(218,240,158,0.13)');
    ctx.fillStyle=mist; ctx.fillRect(0,H*0.72,W,H*0.28);
    const stalks=Math.floor(W/20);
    for(let i=0;i<stalks;i++){
      const sx=(i+0.5)*(W/stalks);
      const phase=i*0.44, sway=Math.sin(k*0.020+phase)*6.5+Math.sin(k*0.036+phase*1.4)*2.8;
      const height=58+Math.sin(i*1.2)*17;
      ctx.save(); ctx.globalAlpha=0.48+Math.sin(i*0.68)*0.13;
      ctx.strokeStyle=`rgba(${178+Math.floor(Math.sin(i*.5)*8)},${158+Math.floor(Math.sin(i*.3)*7)},58,0.78)`;
      ctx.lineWidth=1.3;
      ctx.beginPath(); ctx.moveTo(sx,H); ctx.quadraticCurveTo(sx+sway*.55,H-height*.5,sx+sway,H-height); ctx.stroke();
      // Grain head
      ctx.fillStyle='rgba(253,224,71,0.58)';
      ctx.beginPath(); ctx.ellipse(sx+sway,H-height,3.2,9.5,Math.PI*0.05+sway*.02,0,Math.PI*2); ctx.fill();
      ctx.restore();
    }
  }
  _drawWindLines(){
    const ctx=this.ctx, W=innerWidth, H=innerHeight;
    if(!this._windLines) this._windLines=Array.from({length:15},()=>({
      y:Math.random()*H, x:-W*.2, len:90+Math.random()*170,
      spd:2.0+Math.random()*2.8, op:0.055+Math.random()*0.085, wave:Math.random()*Math.PI*2
    }));
    this._windLines.forEach(l=>{
      l.wave+=0.02; l.x+=l.spd;
      const wy=l.y+Math.sin(l.wave)*13;
      ctx.save(); ctx.globalAlpha=l.op;
      const g=ctx.createLinearGradient(l.x,wy,l.x+l.len,wy);
      g.addColorStop(0,'rgba(163,230,53,0)'); g.addColorStop(0.5,'rgba(163,230,53,0.8)'); g.addColorStop(1,'rgba(163,230,53,0)');
      ctx.strokeStyle=g; ctx.lineWidth=1.2;
      ctx.beginPath(); ctx.moveTo(l.x,wy); ctx.quadraticCurveTo(l.x+l.len*.5,wy-7,l.x+l.len,wy+4); ctx.stroke(); ctx.restore();
      if(l.x>W+l.len){ l.x=-l.len*1.4; l.y=Math.random()*H; l.spd=2.0+Math.random()*2.8; }
    });
  }

  // ‚îÄ‚îÄ Summer: solar corona + rotating rays + solar flares + lens flare + heat haze ‚îÄ‚îÄ
  _drawSun(){
    const ctx=this.ctx, cx=innerWidth*0.86, cy=innerHeight*0.095, k=this.tick;
    // Corona rings
    for(let ring=0;ring<4;ring++){
      const r=85+ring*60, pulse=Math.sin(k*0.008+ring*1.2)*9;
      const g=ctx.createRadialGradient(cx,cy,r*.7,cx,cy,r+pulse);
      g.addColorStop(0,`rgba(253,224,71,${0.065-ring*0.014})`); g.addColorStop(1,'rgba(253,180,0,0)');
      ctx.fillStyle=g; ctx.beginPath(); ctx.arc(cx,cy,r+pulse,0,Math.PI*2); ctx.fill();
    }
    // Nucleus
    const g2=ctx.createRadialGradient(cx,cy,0,cx,cy,48);
    g2.addColorStop(0,'rgba(255,252,200,0.96)'); g2.addColorStop(.45,'rgba(253,224,71,0.9)');
    g2.addColorStop(.75,'rgba(251,191,36,0.6)'); g2.addColorStop(1,'rgba(245,158,11,0)');
    ctx.fillStyle=g2; ctx.beginPath(); ctx.arc(cx,cy,48,0,Math.PI*2); ctx.fill();
    // 16 rotating rays
    for(let i=0;i<16;i++){
      const a=(i/16)*Math.PI*2+k*0.003, len=42+Math.sin(k*0.034+i*.9)*18;
      ctx.save(); ctx.translate(cx,cy); ctx.rotate(a);
      ctx.globalAlpha=0.085+Math.sin(k*0.028+i*.6)*0.03;
      const rg=ctx.createLinearGradient(50,0,50+len,0);
      rg.addColorStop(0,'rgba(253,224,71,0.95)'); rg.addColorStop(1,'rgba(253,224,71,0)');
      ctx.strokeStyle=rg; ctx.lineWidth=2+(i%3===0?1:0);
      ctx.beginPath(); ctx.moveTo(50,0); ctx.lineTo(50+len,0); ctx.stroke(); ctx.restore();
    }
    // Solar flare arc
    if(Math.floor(k/100)%4===0){
      const fa=k*.009, fr=60+Math.sin(k*.04)*9;
      ctx.save(); ctx.globalAlpha=0.075+Math.sin(k*.04)*.035;
      ctx.strokeStyle='rgba(253,224,71,0.65)'; ctx.lineWidth=3;
      ctx.beginPath(); ctx.arc(cx,cy,fr,fa,fa+1.0); ctx.stroke(); ctx.restore();
    }
    // Lens flares
    if(this._lensFlares) this._lensFlares.forEach(f=>{
      ctx.save(); ctx.globalAlpha=f.op+Math.sin(k*0.017)*0.028;
      const fg=ctx.createRadialGradient(f.x,f.y,0,f.x,f.y,f.r);
      fg.addColorStop(0,f.c+'0.88)'); fg.addColorStop(1,f.c+'0)');
      ctx.fillStyle=fg; ctx.beginPath(); ctx.arc(f.x,f.y,f.r,0,Math.PI*2); ctx.fill(); ctx.restore();
    });
    // Heat haze bands
    for(let h=0;h<4;h++){
      const hy=innerHeight*(0.52+h*0.12)+Math.sin(k*0.013+h*1.1)*7;
      const hg=ctx.createLinearGradient(0,hy-9,0,hy+9);
      hg.addColorStop(0,'rgba(251,191,36,0)'); hg.addColorStop(0.5,`rgba(251,191,36,${0.042-h*0.008})`); hg.addColorStop(1,'rgba(251,191,36,0)');
      ctx.fillStyle=hg; ctx.fillRect(0,hy-9,innerWidth,18);
    }
    // Atmospheric haze
    const hz=ctx.createLinearGradient(0,innerHeight*.42,0,innerHeight);
    hz.addColorStop(0,'rgba(245,158,11,0)'); hz.addColorStop(1,'rgba(110,35,0,0.11)');
    ctx.fillStyle=hz; ctx.fillRect(0,innerHeight*.42,innerWidth,innerHeight*.58);
  }

  // ‚îÄ‚îÄ Autumn: wind gusts + vortex leaf swirls ‚îÄ‚îÄ
  _drawWindGusts(){
    const ctx=this.ctx, W=innerWidth, H=innerHeight, k=this.tick;
    if(!this._gustLines) this._gustLines=Array.from({length:13},()=>({
      y:Math.random()*H*.9, x:-W*.3, len:130+Math.random()*210,
      spd:3.2+Math.random()*4.2, op:0.055+Math.random()*0.075, wave:Math.random()*Math.PI*2
    }));
    this._gustLines.forEach(l=>{
      l.x+=l.spd; l.wave+=0.028;
      const by=l.y+Math.sin(l.wave)*22;
      ctx.save(); ctx.globalAlpha=l.op;
      const g=ctx.createLinearGradient(l.x,by,l.x+l.len,by);
      g.addColorStop(0,'rgba(255,200,120,0)'); g.addColorStop(.4,'rgba(255,218,140,0.75)'); g.addColorStop(1,'rgba(255,200,120,0)');
      ctx.strokeStyle=g; ctx.lineWidth=1.6;
      ctx.beginPath(); ctx.moveTo(l.x,by); ctx.bezierCurveTo(l.x+l.len*.25,by-13,l.x+l.len*.75,by+8,l.x+l.len,by-5); ctx.stroke(); ctx.restore();
      if(l.x>W+l.len){ l.x=-l.len*1.4; l.y=Math.random()*H*.9; }
    });
  }

  // ‚îÄ‚îÄ Winter: per-slice undulating aurora + frost vignette + drift wisps ‚îÄ‚îÄ
  _drawAurora(){
    const ctx=this.ctx, k=this.tick, W=innerWidth, H=innerHeight;
    const bands=[
      {y:.11,amp:40,spd:.007,phase:0,   c:['rgba(52,211,153,0)','rgba(52,211,153,0.20)','rgba(52,211,153,0)']},
      {y:.19,amp:30,spd:.009,phase:1.8, c:['rgba(99,102,241,0)','rgba(99,102,241,0.16)','rgba(99,102,241,0)']},
      {y:.26,amp:46,spd:.006,phase:3.2, c:['rgba(147,197,253,0)','rgba(147,197,253,0.22)','rgba(147,197,253,0)']},
      {y:.15,amp:24,spd:.011,phase:.9,  c:['rgba(196,181,253,0)','rgba(196,181,253,0.14)','rgba(196,181,253,0)']},
    ];
    bands.forEach(b=>{
      const cy=H*b.y+Math.sin(k*b.spd+b.phase)*b.amp;
      const thick=52+Math.sin(k*b.spd*1.3+b.phase)*16;
      for(let sx=0;sx<W;sx+=4){
        const sw=Math.sin(k*b.spd*.9+sx*.018+b.phase)*18;
        const scy=cy+sw, sth=thick+sw*.4;
        const sg=ctx.createLinearGradient(0,scy-sth,0,scy+sth);
        sg.addColorStop(0,b.c[0]); sg.addColorStop(.5,b.c[1]); sg.addColorStop(1,b.c[2]);
        ctx.fillStyle=sg; ctx.fillRect(sx,scy-sth,4,sth*2);
      }
    });
    const vg=ctx.createRadialGradient(W/2,H/2,H*.28,W/2,H/2,H*.82);
    vg.addColorStop(0,'rgba(147,197,253,0)'); vg.addColorStop(1,'rgba(96,165,250,0.07)');
    ctx.fillStyle=vg; ctx.fillRect(0,0,W,H);
    if(k%4===0 && this._snowDrift.length<8)
      this._snowDrift.push({x:-90,y:H-6-Math.random()*16,w:90+Math.random()*130,op:.11+Math.random()*0.14,spd:1.9+Math.random()*1.4});
    this._snowDrift.forEach((d,i)=>{
      ctx.save(); ctx.globalAlpha=d.op;
      const dg=ctx.createLinearGradient(d.x,d.y,d.x+d.w,d.y);
      dg.addColorStop(0,'rgba(220,235,255,0)'); dg.addColorStop(.5,'rgba(220,235,255,0.88)'); dg.addColorStop(1,'rgba(220,235,255,0)');
      ctx.fillStyle=dg; ctx.beginPath(); ctx.ellipse(d.x+d.w/2,d.y,d.w/2,3.5,0,0,Math.PI*2); ctx.fill(); ctx.restore();
      d.x+=d.spd; if(d.x>W+110) this._snowDrift.splice(i,1);
    });
    ctx.save(); ctx.globalAlpha=0.04+Math.sin(k*.013)*.022;
    const sg2=ctx.createLinearGradient(0,0,W,0);
    sg2.addColorStop(0,'rgba(147,197,253,0)'); sg2.addColorStop(.3+Math.sin(k*.009)*.18,'rgba(196,181,253,0.88)'); sg2.addColorStop(1,'rgba(147,197,253,0)');
    ctx.fillStyle=sg2; ctx.fillRect(0,H*.04,W,H*.3); ctx.restore();
  }

  _drawLeafShape(ctx, type, s){
    if(type==='maple'){
      ctx.beginPath();
      ctx.moveTo(0,-s); ctx.lineTo(s*.25,-s*.5); ctx.lineTo(s*.78,-s*.65);
      ctx.lineTo(s*.5,-s*.15); ctx.lineTo(s,s*.25); ctx.lineTo(s*.2,s*.1);
      ctx.lineTo(0,s*.6); ctx.lineTo(-s*.2,s*.1); ctx.lineTo(-s,s*.25);
      ctx.lineTo(-s*.5,-s*.15); ctx.lineTo(-s*.78,-s*.65); ctx.lineTo(-s*.25,-s*.5); ctx.closePath(); ctx.fill();
    } else if(type==='oak'){
      ctx.beginPath();
      ctx.moveTo(0,-s*.9); ctx.bezierCurveTo(s*.6,-s*.6,s*.8,-s*.1,s*.5,s*.3);
      ctx.bezierCurveTo(s*.25,s*.7,-s*.25,s*.7,-s*.5,s*.3);
      ctx.bezierCurveTo(-s*.8,-s*.1,-s*.6,-s*.6,0,-s*.9); ctx.closePath(); ctx.fill();
    } else {
      ctx.beginPath(); ctx.ellipse(0,0,s,s*.6,0,0,Math.PI*2); ctx.fill();
    }
  }

  _loop(){
    const ctx=this.ctx, t=this.type; ctx.clearRect(0,0,innerWidth,innerHeight); this.tick++;
    if(t==='kharif')     this._drawStormClouds();
    else if(t==='summer') this._drawSun();
    else if(t==='winter') this._drawAurora();
    else if(t==='rabi')  { this._drawWindLines(); this._drawWheatField(); }
    else if(t==='autumn') this._drawWindGusts();

    this.particles.forEach((p,i)=>{
      ctx.save();
      if(t==='autumn'){
        // Shadow
        ctx.translate(p.x+3,p.y+4); ctx.rotate(p.rot); ctx.globalAlpha=p.opacity*.15;
        ctx.fillStyle='rgba(0,0,0,0.5)'; this._drawLeafShape(ctx,p.leafType,p.size);
        ctx.restore(); ctx.save();
        // Leaf
        ctx.translate(p.x,p.y); ctx.rotate(p.rot); ctx.globalAlpha=p.opacity; ctx.fillStyle=p.color;
        this._drawLeafShape(ctx,p.leafType,p.size);
        // Vein
        ctx.globalAlpha=p.opacity*.2; ctx.strokeStyle='rgba(255,255,255,0.55)'; ctx.lineWidth=0.6;
        ctx.beginPath(); ctx.moveTo(-p.size*.7,0); ctx.lineTo(p.size*.7,0); ctx.stroke();
        // Vortex attraction
        this._vortexes.forEach(v=>{
          const dx=p.x-v.x, dy=p.y-v.y, dd=Math.sqrt(dx*dx+dy*dy);
          if(dd<130){ p.drift+=(-dx/dd)*.16; p.speed+=(-dy/dd)*.08; }
        });
        p.swing+=p.swingSpd; p.x+=p.drift+Math.sin(p.swing)*1.7; p.y+=p.speed; p.rot+=p.rotSpeed;
        p.drift*=.98; p.speed=Math.max(.28,p.speed*.996);
        if(p.y>innerHeight+40||p.x<-90||p.x>innerWidth+90){
          this.particles[i]=null; this._spawn(false);
          this.particles.splice(i,1,this.particles[this.particles.length-1]); this.particles.pop();
        }
      } else if(t==='summer'){
        const wx=p.x+Math.sin(p.wave)*6; ctx.globalAlpha=p.opacity;
        const sg=ctx.createRadialGradient(wx,p.y,0,wx,p.y,p.size*3);
        sg.addColorStop(0,'rgba(255,248,150,0.9)'); sg.addColorStop(.5,'rgba(253,186,36,0.3)'); sg.addColorStop(1,'rgba(245,158,11,0)');
        ctx.fillStyle=sg; ctx.beginPath(); ctx.arc(wx,p.y,p.size*3,0,Math.PI*2); ctx.fill();
        p.wave+=p.waveSpd; p.y-=p.speed; p.x+=p.drift;
        if(p.y<innerHeight*.33) p.y=innerHeight+10;
        if(p.x<0||p.x>innerWidth) p.x=Math.random()*innerWidth;
      } else if(t==='rabi'){
        const wx=p.x+Math.sin(p.wave)*9;
        if(p.isSeed){
          ctx.globalAlpha=p.opacity;
          const sg=ctx.createRadialGradient(wx,p.y,0,wx,p.y,p.size*2);
          sg.addColorStop(0,'rgba(253,224,71,0.95)'); sg.addColorStop(1,'rgba(163,230,53,0)');
          ctx.fillStyle=sg; ctx.beginPath(); ctx.arc(wx,p.y,p.size*2,0,Math.PI*2); ctx.fill();
        } else {
          ctx.globalAlpha=p.opacity; ctx.fillStyle='rgba(163,230,53,0.78)';
          ctx.beginPath(); ctx.arc(wx,p.y,p.size,0,Math.PI*2); ctx.fill();
        }
        p.wave+=p.waveSpd; p.y-=p.speed; p.x+=p.drift;
        if(p.y<-22){ p.y=innerHeight+12; p.x=Math.random()*innerWidth; }
      } else if(t==='winter'){
        const wx=p.x+Math.sin(p.wave)*7;
        ctx.translate(wx,p.y); ctx.rotate(p.rot); ctx.globalAlpha=p.opacity;
        ctx.strokeStyle='rgba(199,210,254,0.9)'; ctx.lineWidth=1.0;
        for(let a=0;a<6;a++){
          const ang=a*(Math.PI/3);
          ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(Math.cos(ang)*p.size,Math.sin(ang)*p.size); ctx.stroke();
          const bx=Math.cos(ang)*p.size*.5, by=Math.sin(ang)*p.size*.5;
          const ba=ang+Math.PI/2, bl=p.size*.28;
          ctx.beginPath(); ctx.moveTo(bx-Math.cos(ba)*bl,by-Math.sin(ba)*bl); ctx.lineTo(bx+Math.cos(ba)*bl,by+Math.sin(ba)*bl); ctx.stroke();
        }
        ctx.globalAlpha=p.opacity*.6; ctx.fillStyle='rgba(219,234,254,0.8)';
        ctx.beginPath(); ctx.arc(0,0,p.size*.18,0,Math.PI*2); ctx.fill();
        p.wave+=p.waveSpd; p.y+=p.speed; p.x+=p.drift; p.rot+=p.rotSpeed;
        if(p.y>innerHeight+22){
          this.particles[i]=null; this._spawn(false);
          this.particles.splice(i,1,this.particles[this.particles.length-1]); this.particles.pop();
        }
      }
      ctx.restore();
    });
    // Drift vortex centers (autumn)
    if(t==='autumn') this._vortexes.forEach(v=>{
      v.life--; if(v.life<=0){ v.x=innerWidth*(.1+Math.random()*.8); v.y=innerHeight*(.15+Math.random()*.55); v.life=420+Math.random()*520; }
      v.x+=Math.sin(this.tick*.006+v.phase)*.42;
    });
    this.raf=requestAnimationFrame(()=>this._loop());
  }
}
let seasonOverlay;
let weatherSys;

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  SEASON THEME
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SEASON_CFG = {
  'Kharif':     { badge:'‚òî Kharif',     cls:'season-kharif', tint:'#0ea5e9', weather:'rain',    overlay:'kharif' },
  'Rabi':       { badge:'üåæ Rabi',       cls:'season-rabi',   tint:'#a3e635', weather:null,       overlay:'rabi'   },
  'Summer':     { badge:'‚òÄÔ∏è Summer',     cls:'season-summer', tint:'#f97316', weather:'embers',  overlay:'summer' },
  'Winter':     { badge:'‚ùÑÔ∏è Winter',     cls:'season-winter', tint:'#93c5fd', weather:'snow',    overlay:'winter' },
  'Autumn':     { badge:'üçÇ Autumn',     cls:'season-autumn', tint:'#f59e0b', weather:'embers',  overlay:'autumn' },
  'Whole Year': { badge:'üåè Whole Year', cls:'season-whole',  tint:'#00e5a0', weather:null,       overlay:'whole'  },
};

const _SEASON_CLASSES = ['season-kharif','season-rabi','season-summer','season-winter','season-autumn','season-whole'];

// Auto-detect current Indian agricultural season by calendar month
function getCurrentSeason(){
  const m = new Date().getMonth() + 1; // 1-12
  if(m >= 6 && m <= 9)    return 'Kharif';  // Jun‚ÄìSep  monsoon
  if(m === 10 || m === 11) return 'Autumn';  // Oct‚ÄìNov
  if(m === 12 || m <= 2)   return 'Winter';  // Dec‚ÄìFeb
  if(m >= 3 && m <= 5)     return 'Summer';  // Mar‚ÄìMay
  return 'Whole Year';
}

function setSeasonTheme(season){
  const key = Object.keys(SEASON_CFG).find(k => season && season.toLowerCase().includes(k.toLowerCase()));
  const cfg = key ? SEASON_CFG[key] : SEASON_CFG['Whole Year'];

  // 1. Badge
  const badge = document.getElementById('season-badge');
  if(badge){
    badge.textContent = cfg.badge;
    badge.style.opacity = '1';
    badge.style.removeProperty('color');
    badge.style.removeProperty('border-color');
    badge.style.removeProperty('background');
  }

  // 2. Body palette class (animates CSS vars + background-color)
  _SEASON_CLASSES.forEach(c => document.body.classList.remove(c));
  document.body.classList.add(cfg.cls);

  // 3. Three.js tint
  if(window.bgControl) window.bgControl.setTint(cfg.tint);

  // 4. Weather particles
  if(weatherSys) weatherSys.setType(cfg.weather);

  // 5. Season overlay effects
  if(seasonOverlay) seasonOverlay.setType(cfg.overlay);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  3D TILT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initTilts(){
  document.querySelectorAll('.glass-card,.chart-card,.stat-card').forEach(card=>{
    card.addEventListener('mousemove', e=>{
      const {left,top,width,height} = card.getBoundingClientRect();
      const x = (e.clientX-left)/width-.5;
      const y = (e.clientY-top)/height-.5;
      card.style.transform = `perspective(900px) rotateY(${x*10}deg) rotateX(${-y*10}deg) translateY(-6px)`;
    });
    card.addEventListener('mouseleave', ()=>{ card.style.transform = ''; });
  });
}

async function loadMeta(){
  try{
    const d=await fetch(`${API}/meta`).then(r=>r.json());
    populate('f-state',d.states);
    populate('f-season',d.seasons);
    populate('f-crop',d.crops);
    // Populate chart filter dropdowns at the same time
    const cfState=document.getElementById('cf-state');
    const cfCrop=document.getElementById('cf-crop');
    if(cfState&&cfState.options.length<=1) d.states.forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v.trim();cfState.appendChild(o);});
    if(cfCrop&&cfCrop.options.length<=1)   d.crops.forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v.trim();cfCrop.appendChild(o);});
    // populate compare crop select
    const cmpSel = document.getElementById('compare-crop-select');
    if(cmpSel) d.crops.forEach(c=>{
      const o=document.createElement('option'); o.value=c; o.textContent=c; cmpSel.appendChild(o);
    });
    // season theme on change ‚Äî sync dropdown to the auto-detected season
    const fSeason = document.getElementById('f-season');
    if(fSeason){
      fSeason.addEventListener('change', e=>setSeasonTheme(e.target.value));
      const autoS = getCurrentSeason();
      const matched = Array.from(fSeason.options).find(o => o.value.toLowerCase().includes(autoS.toLowerCase()));
      if(matched){ fSeason.value = matched.value; setSeasonTheme(matched.value); }
      else setSeasonTheme(fSeason.value);
    }
  }catch(e){toast('‚ö†Ô∏è Backend offline ‚Äî run: uvicorn backend.main:app --reload','error');}
}

function populate(id,arr){
  const s=document.getElementById(id);
  s.innerHTML=arr.map(v=>`<option value="${v}">${v.trim()}</option>`).join('');
}

async function loadStats(){
  try{
    const d=await fetch(`${API}/stats`).then(r=>r.json());
    animNum('s-records',d.total_records);
    animNum('s-states',d.total_states);
    animNum('s-crops',d.total_crops);
    animNum('s-seasons',d.total_seasons);
    document.getElementById('s-years').textContent=d.year_range;
    document.getElementById('s-yield').textContent=d.avg_yield;
  }catch(_){}
}

function animNum(id,target){
  const el=document.getElementById(id);
  if(!el)return;
  el.classList.add('glowing');
  const dur=1400,start=Date.now();
  const t=setInterval(()=>{
    const p=Math.min((Date.now()-start)/dur,1);
    const ease=1-Math.pow(1-p,4);
    el.textContent=Math.floor(ease*target).toLocaleString();
    if(p>=1){
      clearInterval(t);
      el.textContent=target.toLocaleString();
      setTimeout(()=>el.classList.remove('glowing'),600);
    }
  },16);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  PREDICT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function runPredict(){
  const btn=document.getElementById('predict-btn');
  btn.disabled=true; btn.textContent='‚è≥ Processing‚Ä¶';

  const body={
    state:  document.getElementById('f-state').value,
    season: document.getElementById('f-season').value,
    crop:   document.getElementById('f-crop').value,
    year:   +document.getElementById('f-year').value,
    area:   +document.getElementById('f-area').value,
  };

  lastPredParams=body;
  try{
    const [pR,fR,sR]=await Promise.all([
      fetch(`${API}/predict`,pick(body)),
      fetch(`${API}/forecast`,pick({...body,start_year:body.year,n:5})),
      fetch(`${API}/shap`,pick(body)),
    ]);
    if(!pR.ok) throw new Error(await pR.text());
    const [pred,fc,shap]=[await pR.json(),await fR.json(),await sR.json()];
    renderResult(pred,body);
    renderForecast(fc);
    renderShap(shap);
    saveToHistory(pred,body);
    toast('‚úÖ Prediction complete! Loading contextual analysis‚Ä¶');
    // Load contextual analytics with user's parameters
    loadContextual(body.state, body.crop, body.season, body.year);
    // Update map if it's already open
    if(mapInst) refreshMap();
  }catch(e){toast('‚ùå '+e.message,'error');}
  finally{btn.disabled=false;btn.textContent='‚ö° Predict Yield';}
}

function pick(body){
  return{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)};
}

function renderResult(pred,body){
  const el=document.getElementById('result-panel');
  // Confidence bar
  let confHtml='';
  if(pred.conf_low!=null && pred.conf_high!=null){
    const mn=0, mx=pred.conf_high*1.25||10;
    const lo=Math.max(0,Math.min(100,(pred.conf_low/mx)*100));
    const hi=Math.max(0,Math.min(100,(pred.conf_high/mx)*100));
    const mid=Math.max(0,Math.min(100,(pred.yield/mx)*100));
    confHtml=`<div class="conf-wrap">
      <div class="conf-title">Confidence Range (10‚Äì90th pct)</div>
      <div class="conf-track">
        <div class="conf-range" style="left:${lo}%;width:${Math.max(1,hi-lo)}%"></div>
        <div class="conf-dot" style="left:${mid}%"></div>
      </div>
      <div class="conf-bounds">
        <span class="conf-lo">${pred.conf_low.toFixed(2)}</span>
        <span class="conf-hi">${pred.conf_high.toFixed(2)}</span>
      </div>
    </div>`;
  }
  el.innerHTML=`
    <div class="result-main">
      <div class="holo-sweep"></div>
      <div class="rlabel">üåæ Predicted Yield</div>
      <div class="rval" id="anim-yld">0.00</div>
      <div class="runit">Tonnes per Hectare (T/Ha)</div>
      ${confHtml}
    </div>
    <div class="result-row">
      <div class="result-mini blue">
        <div class="rlabel">üì¶ Production</div>
        <div class="rval">${pred.production.toLocaleString(undefined,{maximumFractionDigits:1})}</div>
      </div>
      <div class="result-mini amber">
        <div class="rlabel">üìê Area</div>
        <div class="rval">${body.area} Ha</div>
      </div>
    </div>
    <div class="result-info">
      <b>${body.crop}</b> &nbsp;¬∑&nbsp; <b>${body.state}</b><br/>
      Season: <b>${body.season.trim()}</b> &nbsp;¬∑&nbsp; Year: <b>${body.year}</b>
    </div>`;
  const yldEl = document.getElementById('anim-yld');
  if(yldEl) yldEl.classList.add('glowing');
  animDec('anim-yld',pred.yield);
  setTimeout(()=>{ if(yldEl) yldEl.classList.remove('glowing'); },1600);
}

function animDec(id,target){
  const el=document.getElementById(id);
  const dur=1000,start=Date.now();
  const t=setInterval(()=>{
    const p=Math.min((Date.now()-start)/dur,1);
    const ease=1-Math.pow(1-p,3);
    el.textContent=(ease*target).toFixed(2);
    if(p>=1){clearInterval(t);el.textContent=target.toFixed(2);}
  },16);
}

function renderForecast(fc){
  document.getElementById('forecast-box').style.display='block';
  if(forecastInst){forecastInst.destroy();}
  forecastInst=new Chart(document.getElementById('forecast-chart'),{
    type:'line',
    data:{labels:fc.years,datasets:[{
      label:'Yield (T/Ha)',data:fc.yields,
      borderColor:'#00e5a0',backgroundColor:'rgba(0,229,160,.07)',
      fill:true,tension:.45,pointBackgroundColor:'#00e5a0',
      pointRadius:5,pointHoverRadius:8,borderWidth:2.5,
    }]},
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:false},tooltip:tooltipStyle()},
      scales:{x:axisStyle(),y:axisStyle()},
    }
  });
}

function renderShap(shap){
  const max=Math.max(...shap.shap_values.map(Math.abs),.0001);
  const rows=shap.features.map((f,i)=>{
    const v=shap.shap_values[i];
    const pct=Math.abs(v)/max*100;
    const col=v>=0?'#00e5a0':'#f87171';
    return `<div class="shap-row" style="animation-delay:${i*0.07}s">
      <div class="shap-label">${f}</div>
      <div class="shap-bar-bg">
        <div class="shap-bar" style="width:${pct}%;background:${col}">
          ${pct>15?f:''}
        </div>
      </div>
      <div class="shap-val" style="color:${col}">${v>=0?'+':''}${v.toFixed(4)}</div>
    </div>`;
  }).join('');
  document.getElementById('shap-content').innerHTML=`
    <div class="shap-base">
      Baseline: <b style="color:var(--accent)">${shap.base_value.toFixed(4)}</b> T/Ha
      &nbsp;¬∑&nbsp; <span style="color:#00e5a0">‚ñÆ Positive</span>
      &nbsp; <span style="color:#f87171">‚ñÆ Negative</span>
    </div>
    <div>${rows}</div>`;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  ANALYTICS CHARTS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tooltipStyle(){
  return{backgroundColor:'rgba(2,13,20,.95)',borderColor:'rgba(255,255,255,.1)',
    borderWidth:1,titleColor:'#e2e8f0',bodyColor:'#94a3b8',cornerRadius:10,padding:10};
}
function axisStyle(){
  return{grid:{color:'rgba(255,255,255,.05)'},ticks:{color:'#64748b',font:{size:10}}};
}

const CHART_OPTS={responsive:true,maintainAspectRatio:false,
  plugins:{legend:{labels:{color:'#94a3b8',font:{size:11}}},tooltip:tooltipStyle()},
  scales:{x:axisStyle(),y:axisStyle()}};

async function loadCharts(filterState='',filterCrop=''){
  const isFiltered=filterState||filterCrop;
  if(!isFiltered&&chartsLoaded)return;
  Object.values(mainCharts).forEach(c=>{if(c)c.destroy();});
  mainCharts={topcrop:null,season:null,trend:null,state:null};
  const badge=document.getElementById('chart-filter-badge');
  const resetBtn=document.getElementById('chart-reset-btn');
  if(isFiltered){
    chartsLoaded=false;
    const parts=[filterState?filterState.trim():'',filterCrop||''].filter(Boolean);
    if(badge){badge.style.display='inline';badge.textContent='üìç '+parts.join(' ¬∑ ');}
    if(resetBtn)resetBtn.style.display='';
  } else {
    chartsLoaded=true;
    if(badge)badge.style.display='none';
    if(resetBtn)resetBtn.style.display='none';
  }
  const setTitle=(id,txt)=>{const el=document.getElementById(id);if(el)el.textContent=txt;};
  try{
    if(isFiltered){
      const [sd,cd]=await Promise.all([
        filterState?fetch(`${API}/analytics/by-state?state=${encodeURIComponent(filterState)}`).then(r=>r.json()):Promise.resolve(null),
        filterCrop?fetch(`${API}/analytics/by-crop?crop=${encodeURIComponent(filterCrop)}${filterState?'&state='+encodeURIComponent(filterState):''}`).then(r=>r.json()):Promise.resolve(null),
      ]);
      setTitle('chart-title-topcrop', sd?`üèÜ Top Crops in ${filterState.trim()}`:'üèÜ Top 10 Crops by Avg Yield');
      if(sd){
        mainCharts.topcrop=new Chart(document.getElementById('chart-topcrop'),{
          type:'bar',data:{labels:sd.top_crops.crops,datasets:[{data:sd.top_crops.yields,
            backgroundColor:sd.top_crops.crops.map((c,i)=>c===filterCrop?'rgba(0,229,160,.9)':`hsla(${155+i*9},75%,55%,.8)`),
            borderRadius:8,borderSkipped:false}]},
          options:{...CHART_OPTS,indexAxis:'y',plugins:{...CHART_OPTS.plugins,legend:{display:false}}}
        });
      } else {
        const tc=await fetch(`${API}/analytics/top-crops`).then(r=>r.json());
        mainCharts.topcrop=new Chart(document.getElementById('chart-topcrop'),{
          type:'bar',data:{labels:tc.crops,datasets:[{data:tc.yields,backgroundColor:tc.crops.map((_,i)=>`hsla(${155+i*9},75%,55%,.8)`),borderRadius:8,borderSkipped:false}]},
          options:{...CHART_OPTS,indexAxis:'y',plugins:{...CHART_OPTS.plugins,legend:{display:false}}}
        });
      }
      setTitle('chart-title-season', sd?`üå§Ô∏è Season Yield in ${filterState.trim()}`:'üå§Ô∏è Season-wise Yield (Mean vs Median)');
      if(sd){
        mainCharts.season=new Chart(document.getElementById('chart-season'),{
          type:'bar',data:{labels:sd.season_dist.map(r=>r.season.trim()),datasets:[{label:'Avg Yield',data:sd.season_dist.map(r=>r.mean),backgroundColor:'rgba(0,229,160,.75)',borderRadius:7}]},
          options:{...CHART_OPTS,plugins:{...CHART_OPTS.plugins,legend:{display:false}}}
        });
      } else {
        const gl=await fetch(`${API}/analytics/season-distribution`).then(r=>r.json());
        mainCharts.season=new Chart(document.getElementById('chart-season'),{
          type:'bar',data:{labels:gl.map(r=>r.season.trim()),datasets:[
            {label:'Mean',data:gl.map(r=>r.mean),backgroundColor:'rgba(0,229,160,.75)',borderRadius:7},
            {label:'Median',data:gl.map(r=>r.median),backgroundColor:'rgba(14,165,233,.75)',borderRadius:7}]},
          options:CHART_OPTS
        });
      }
      setTitle('chart-title-trend', cd?`üìÖ Yearly Trend ‚Äî ${filterCrop}${filterState?' in '+filterState.trim():''}`:'üìÖ Yearly Average Yield Trend');
      if(cd){
        mainCharts.trend=new Chart(document.getElementById('chart-trend'),{
          type:'line',data:{labels:cd.yearly_trend.years,datasets:[{label:'Yield T/Ha',data:cd.yearly_trend.yields,borderColor:'#f59e0b',backgroundColor:'rgba(245,158,11,.06)',fill:true,tension:.45,borderWidth:2.5,pointRadius:3,pointBackgroundColor:'#f59e0b'}]},
          options:CHART_OPTS
        });
      } else {
        const yt=await fetch(`${API}/analytics/yearly-trend`).then(r=>r.json());
        mainCharts.trend=new Chart(document.getElementById('chart-trend'),{
          type:'line',data:{labels:yt.years,datasets:[{label:'Avg Yield T/Ha',data:yt.yields,borderColor:'#f59e0b',backgroundColor:'rgba(245,158,11,.06)',fill:true,tension:.45,borderWidth:2.5,pointRadius:3,pointBackgroundColor:'#f59e0b'}]},
          options:CHART_OPTS
        });
      }
      setTitle('chart-title-state', cd?`üó∫Ô∏è Top States for ${filterCrop}`:'üó∫Ô∏è Top 25 States by Avg Yield');
      if(cd){
        mainCharts.state=new Chart(document.getElementById('chart-state'),{
          type:'bar',data:{labels:cd.top_states.states,datasets:[{data:cd.top_states.yields,
            backgroundColor:cd.top_states.states.map((s,i)=>s===filterState?'rgba(245,158,11,.9)':`hsla(${200+i*6},70%,55%,.78)`),
            borderRadius:6,borderSkipped:false}]},
          options:{...CHART_OPTS,indexAxis:'y',plugins:{...CHART_OPTS.plugins,legend:{display:false}}}
        });
      } else {
        const sh=await fetch(`${API}/analytics/state-heatmap`).then(r=>r.json());
        mainCharts.state=new Chart(document.getElementById('chart-state'),{
          type:'bar',data:{labels:sh.states.slice(0,25),datasets:[{data:sh.yields.slice(0,25),backgroundColor:sh.states.slice(0,25).map((_,i)=>`hsla(${200+i*6},70%,55%,.78)`),borderRadius:6,borderSkipped:false}]},
          options:{...CHART_OPTS,indexAxis:'y',plugins:{...CHART_OPTS.plugins,legend:{display:false}}}
        });
      }
      toast('üìä Charts updated for your selection!');
    } else {
      setTitle('chart-title-topcrop','üèÜ Top 10 Crops by Avg Yield');
      setTitle('chart-title-season','üå§Ô∏è Season-wise Yield (Mean vs Median)');
      setTitle('chart-title-trend','üìÖ Yearly Average Yield Trend');
      setTitle('chart-title-state','üó∫Ô∏è Top 25 States by Avg Yield');
      const [tc,sd,yt,sh]=await Promise.all([
        fetch(`${API}/analytics/top-crops`).then(r=>r.json()),
        fetch(`${API}/analytics/season-distribution`).then(r=>r.json()),
        fetch(`${API}/analytics/yearly-trend`).then(r=>r.json()),
        fetch(`${API}/analytics/state-heatmap`).then(r=>r.json()),
      ]);
      mainCharts.topcrop=new Chart(document.getElementById('chart-topcrop'),{
        type:'bar',data:{labels:tc.crops,datasets:[{data:tc.yields,backgroundColor:tc.crops.map((_,i)=>`hsla(${155+i*9},75%,55%,.8)`),borderRadius:8,borderSkipped:false}]},
        options:{...CHART_OPTS,indexAxis:'y',plugins:{...CHART_OPTS.plugins,legend:{display:false}}}
      });
      mainCharts.season=new Chart(document.getElementById('chart-season'),{
        type:'bar',data:{labels:sd.map(r=>r.season.trim()),datasets:[
          {label:'Mean',data:sd.map(r=>r.mean),backgroundColor:'rgba(0,229,160,.75)',borderRadius:7},
          {label:'Median',data:sd.map(r=>r.median),backgroundColor:'rgba(14,165,233,.75)',borderRadius:7}]},
        options:CHART_OPTS
      });
      mainCharts.trend=new Chart(document.getElementById('chart-trend'),{
        type:'line',data:{labels:yt.years,datasets:[{label:'Avg Yield T/Ha',data:yt.yields,borderColor:'#f59e0b',backgroundColor:'rgba(245,158,11,.06)',fill:true,tension:.45,borderWidth:2.5,pointRadius:3,pointBackgroundColor:'#f59e0b'}]},
        options:CHART_OPTS
      });
      mainCharts.state=new Chart(document.getElementById('chart-state'),{
        type:'bar',data:{labels:sh.states.slice(0,25),datasets:[{data:sh.yields.slice(0,25),backgroundColor:sh.states.slice(0,25).map((_,i)=>`hsla(${200+i*6},70%,55%,.78)`),borderRadius:6,borderSkipped:false}]},
        options:{...CHART_OPTS,indexAxis:'y',plugins:{...CHART_OPTS.plugins,legend:{display:false}}}
      });
    }
  }catch(e){console.error('Charts failed:',e);}
}
function applyChartFilters(){
  loadCharts(document.getElementById('cf-state').value, document.getElementById('cf-crop').value);
}
function resetChartFilters(){
  document.getElementById('cf-state').value='';
  document.getElementById('cf-crop').value='';
  chartsLoaded=false;
  loadCharts();
}
function populateChartFilters(){
  // cf-state & cf-crop are already filled in loadMeta ‚Äî just sync from last prediction
  if(lastPredParams){
    const cfState=document.getElementById('cf-state');
    const cfCrop=document.getElementById('cf-crop');
    if(cfState) cfState.value=lastPredParams.state||'';
    if(cfCrop)  cfCrop.value=lastPredParams.crop||'';
    applyChartFilters();
  } else if(!chartsLoaded){
    loadCharts();
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  TAB SWITCH
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(id,btn){
  document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('pane-'+id).classList.add('active');
  btn.classList.add('active');
  if(id==='charts') populateChartFilters();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  DATA TABLE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function seasonBadge(s){
  const sl=(s||'').trim().toLowerCase();
  if(sl.includes('kharif')) return `<span class="badge badge-kharif">${s.trim()}</span>`;
  if(sl.includes('rabi'))   return `<span class="badge badge-rabi">${s.trim()}</span>`;
  if(sl.includes('whole'))  return `<span class="badge badge-whole">${s.trim()}</span>`;
  return `<span class="badge badge-other">${s.trim()}</span>`;
}

async function loadTable(){
  document.getElementById('tbl-body').innerHTML=
    '<tr><td colspan="8"><div class="spinner"></div></td></tr>';
  document.getElementById('tbl-count').textContent='Loading‚Ä¶';
  try{
    const d=await fetch(`${API}/data/sample?n=200`).then(r=>r.json());
    tableData=d;
    renderTable(d);
  }catch(e){
    document.getElementById('tbl-body').innerHTML=
      '<tr><td colspan="8" style="text-align:center;padding:32px;color:var(--muted)">'+
      'Could not load data. Is the backend running?</td></tr>';
  }
}

function renderTable(rows){
  const body=document.getElementById('tbl-body');
  document.getElementById('tbl-count').textContent=`Showing ${rows.length} records`;
  if(!rows.length){
    body.innerHTML='<tr><td colspan="8" style="text-align:center;padding:32px;color:var(--muted)">No matching records</td></tr>';
    return;
  }
  body.innerHTML=rows.map(r=>`<tr>
    <td><b style="color:var(--text)">${r.State_Name||'‚Äî'}</b></td>
    <td style="color:var(--muted)">${r.District_Name||'‚Äî'}</td>
    <td>${r.Crop_Year||'‚Äî'}</td>
    <td>${seasonBadge(r.Season||'')}</td>
    <td style="color:var(--accent2)">${r.Crop||'‚Äî'}</td>
    <td>${r.Area!=null?r.Area.toFixed(1):'‚Äî'}</td>
    <td>${r.Production!=null?r.Production.toFixed(1):'‚Äî'}</td>
    <td><b style="color:var(--accent)">${r.Yield!=null?r.Yield.toFixed(3):'‚Äî'}</b></td>
  </tr>`).join('');
}

function filterTable(){
  const q=document.getElementById('tbl-search').value.toLowerCase();
  renderTable(q
    ? tableData.filter(r=>
        (r.State_Name||'').toLowerCase().includes(q)||
        (r.Crop||'').toLowerCase().includes(q)||
        (r.Season||'').toLowerCase().includes(q)||
        (r.District_Name||'').toLowerCase().includes(q))
    : tableData);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  INDIA CHOROPLETH MAP
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let mapInst=null, geoLayer=null, stateYieldData={}, lastPredParams=null;
const GEOJSON_URL='https://raw.githubusercontent.com/geohacker/india/master/state/india_telengana.geojson';

// Fuzzy match GeoJSON state name ‚Üí dataset state name
function matchState(geoName, dataKeys){
  const n=geoName.toLowerCase().trim();
  // direct
  const direct=dataKeys.find(k=>k.toLowerCase().trim()===n);
  if(direct)return direct;
  // partial
  const partial=dataKeys.find(k=>k.toLowerCase().includes(n)||n.includes(k.toLowerCase().substring(0,6)));
  return partial||null;
}

async function initMap(){
  if(mapInst)return; // already created
  await new Promise(r=>setTimeout(r,80)); // let tab render
  mapInst=L.map('india-map',{zoomControl:true,attributionControl:false,
    center:[22,82],zoom:4.5,minZoom:3,maxZoom:8});

  // Dark tile layer
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png',{
    subdomains:'abcd',maxZoom:19
  }).addTo(mapInst);

  // Load yield data then GeoJSON
  try{
    stateYieldData=await fetch(`${API}/analytics/state-geo`).then(r=>r.json());
    await loadGeoJSON(stateYieldData);
  }catch(e){console.error('Map load failed:',e);}
}

async function loadGeoJSON(yieldMap){
  const keys=Object.keys(yieldMap);
  const vals=Object.values(yieldMap);
  const mn=Math.min(...vals), mx2=Math.max(...vals);

  function getColor(v){
    if(v==null)return'#1a2a30';
    const t=(v-mn)/(mx2-mn||1);
    // deep blue ‚Üí green gradient
    const r=Math.round(2+t*0),g=Math.round(50+t*180),b=Math.round(80+t*20);
    return `rgb(${Math.round(2*(1-t)+14*t)},${Math.round(50+t*160)},${Math.round(80-t*20)})`;
  }

  // color scale: dark‚Üíteal‚Üígreen
  function colorScale(v){
    if(v==null)return'#1a2a30';
    const t=Math.pow((v-mn)/(mx2-mn||1),0.5);
    const colors=[
      [10,30,44],   // dark blue-grey (low)
      [0,120,100],  // teal (mid)
      [0,220,150],  // bright green (high)
    ];
    const idx=t*(colors.length-1);
    const lo=colors[Math.floor(idx)], hi=colors[Math.ceil(idx)||colors.length-1];
    const f=idx-Math.floor(idx);
    return `rgb(${Math.round(lo[0]+(hi[0]-lo[0])*f)},${Math.round(lo[1]+(hi[1]-lo[1])*f)},${Math.round(lo[2]+(hi[2]-lo[2])*f)})`;
  }

  try{
    const geo=await fetch(GEOJSON_URL).then(r=>r.json());
    if(geoLayer){mapInst.removeLayer(geoLayer);}
    geoLayer=L.geoJSON(geo,{
      style:feature=>{
        const gName=feature.properties.NAME_1||feature.properties.name||'';
        const dsName=matchState(gName,keys);
        const yld=dsName?yieldMap[dsName]:null;
        return{
          fillColor:colorScale(yld),
          weight:1,opacity:.7,color:'rgba(0,229,160,0.25)',
          fillOpacity:.82
        };
      },
      onEachFeature:(feature,layer)=>{
        const gName=feature.properties.NAME_1||feature.properties.name||'';
        const dsName=matchState(gName,keys);
        const yld=dsName?yieldMap[dsName]:null;
        layer.on({
          mouseover:e=>{
            e.target.setStyle({weight:2.5,color:'#00e5a0',fillOpacity:.95});
            document.getElementById('map-selected-info').innerHTML=
              `<b style="color:var(--text)">${dsName||gName}</b> &nbsp;¬∑&nbsp; `+
              `Avg Yield: <b style="color:var(--accent)">${yld?yld.toFixed(3)+' T/Ha':'No data'}</b>`;
          },
          mouseout:e=>{
            geoLayer.resetStyle(e.target);
            document.getElementById('map-selected-info').innerHTML='Hover over a state to see details';
          },
          click:()=>{
            if(dsName){
              document.getElementById('f-state').value=dsName;
              nav('predict');
              toast(`üìç State set to ${dsName}`);
            }
          }
        });
        if(yld!=null){
          layer.bindPopup(
            `<b style="font-size:1rem">${dsName||gName}</b><br/>`+
            `Avg Yield: <b style="color:#00e5a0">${yld.toFixed(3)} T/Ha</b><br/>`+
            `<span style="font-size:.78rem;color:#64748b">Click to select this state</span>`);
        }
      }
    }).addTo(mapInst);

    // Legend
    const legend=L.control({position:'bottomright'});
    legend.onAdd=()=>{
      const d=L.DomUtil.create('div','map-legend');
      d.innerHTML=`<b>Avg Yield (T/Ha)</b>`+
        ['High','Mid','Low'].map((l,i)=>{
          const v=mx2-(i*(mx2-mn)/2);
          return `<div class="legend-item"><div class="legend-swatch" style="background:${colorScale(v)}"></div>${l}: ${v.toFixed(1)}</div>`;
        }).join('');
      return d;
    };
    legend.addTo(mapInst);

    // Info overlay
    const info=L.control({position:'topleft'});
    info.onAdd=()=>{
      const d=L.DomUtil.create('div','map-overlay-info');
      d.innerHTML='üó∫Ô∏è <b style="color:#e2e8f0">India Crop Yield Map</b><br/>Hover: details &nbsp;¬∑&nbsp; Click: select state';
      return d;
    };
    info.addTo(mapInst);
  }catch(e){console.error('GeoJSON fetch failed:',e);}
}

async function refreshMap(){
  const metric=document.getElementById('map-metric')?.value;
  if(!mapInst)return;
  if(metric==='filtered'&&lastPredParams){
    // Build filtered yield map for selected state's crop
    try{
      const d=await fetch(`${API}/analytics/by-crop?crop=${encodeURIComponent(lastPredParams.crop)}`).then(r=>r.json());
      toast(`üó∫Ô∏è Map filtered for: ${lastPredParams.crop}`);
    }catch(e){}
  }else{
    stateYieldData=await fetch(`${API}/analytics/state-geo`).then(r=>r.json());
    await loadGeoJSON(stateYieldData);
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  CONTEXTUAL ANALYTICS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let ctxCharts={c1:null,c2:null,c3:null,c4:null};

async function loadContextual(state,crop,season,year){
  const section=document.getElementById('contextual');
  section.style.display='block';
  document.getElementById('ctx-sub').textContent=
    `Showing data for: ${state.trim()} ¬∑ ${crop} ¬∑ ${season.trim()} season`;

  try{
    // by-state always works; by-crop may 404 when crop not grown in that state
    const sdProm = fetch(`${API}/analytics/by-state?state=${encodeURIComponent(state)}`).then(r=>r.json());
    const cdProm = fetch(`${API}/analytics/by-crop?crop=${encodeURIComponent(crop)}&state=${encodeURIComponent(state)}`).then(r=>r.json());
    let [sd, cd] = await Promise.all([sdProm, cdProm]);

    // Fallback: if crop+state returned no data, retry crop globally
    if(cd && cd.detail){
      cd = await fetch(`${API}/analytics/by-crop?crop=${encodeURIComponent(crop)}`).then(r=>r.json());
    }
    if(!sd || sd.detail) throw new Error('No state data');
    const cdOk = cd && !cd.detail;

    // Derive fields the by-state endpoint doesn't return directly
    const stateAvg = sd.season_dist && sd.season_dist.length
      ? (sd.season_dist.reduce((a,r)=>a+r.mean,0)/sd.season_dist.length).toFixed(2) : '‚Äî';
    const topCrop  = sd.top_crops && sd.top_crops.crops.length ? sd.top_crops.crops[0].trim() : '‚Äî';
    const cropAvg  = cdOk && cd.avg_yield!=null  ? cd.avg_yield  : '‚Äî';
    const cropRecs = cdOk && cd.total_records!=null ? cd.total_records.toLocaleString() : '‚Äî';
    const sLbl = state.length>14 ? state.substring(0,14)+'‚Ä¶' : state.trim();
    const cLbl = crop.length>12  ? crop.substring(0,12)+'‚Ä¶'  : crop;
    // Stat cards
    document.getElementById('ctx-stats').innerHTML=`
      <div class="ctx-stat"><div class="cv">${topCrop}</div><div class="cl">Top Crop in ${sLbl}</div></div>
      <div class="ctx-stat"><div class="cv">${stateAvg}</div><div class="cl">State Avg Yield T/Ha</div></div>
      <div class="ctx-stat"><div class="cv">${sd.season_dist?sd.season_dist.length:'‚Äî'}</div><div class="cl">Seasons w/ Data</div></div>
      <div class="ctx-stat"><div class="cv">${cropAvg}</div><div class="cl">${cLbl} Avg T/Ha</div></div>
      <div class="ctx-stat"><div class="cv">${cropRecs}</div><div class="cl">${cLbl} Records</div></div>`;

    // Destroy old charts
    Object.values(ctxCharts).forEach(c=>c&&c.destroy());

    // Chart 1: Top crops in state (highlight selected crop)
    document.getElementById('ctx-chart1-title').textContent=`üåæ Top Crops in ${state.trim()}`;
    ctxCharts.c1=new Chart(document.getElementById('ctx-chart1'),{
      type:'bar',
      data:{labels:sd.top_crops.crops,datasets:[{
        data:sd.top_crops.yields,
        backgroundColor:sd.top_crops.crops.map(c=>c===crop?'rgba(0,229,160,.9)':'rgba(14,165,233,.5)'),
        borderRadius:8,borderSkipped:false,
      }]},
      options:{...CHART_OPTS,indexAxis:'y',plugins:{...CHART_OPTS.plugins,
        legend:{display:false},
        tooltip:{...tooltipStyle(),callbacks:{label:ctx=>`${ctx.parsed.x.toFixed(3)} T/Ha`}}}}
    });

    // Chart 2: Season distribution in state (highlight selected season)
    document.getElementById('ctx-chart2-title').textContent=`üìÖ Season Distribution in ${state.trim()}`;
    ctxCharts.c2=new Chart(document.getElementById('ctx-chart2'),{
      type:'bar',
      data:{labels:sd.season_dist.map(r=>r.season.trim()),datasets:[{
        label:'Mean',
        data:sd.season_dist.map(r=>r.mean),
        backgroundColor:sd.season_dist.map(r=>r.season.trim()===season.trim()?'rgba(245,158,11,.9)':'rgba(14,165,233,.45)'),
        borderRadius:7,
      }]},
      options:{...CHART_OPTS,plugins:{...CHART_OPTS.plugins,legend:{display:false}}}
    });

    // Chart 3: Yearly trend for this crop (in state if available, else global)
    if(cdOk && cd.yearly_trend && cd.yearly_trend.years.length){
      document.getElementById('ctx-chart3-title').textContent=`üìà Yearly Trend ‚Äî ${crop} in ${state.trim()}`;
      ctxCharts.c3=new Chart(document.getElementById('ctx-chart3'),{
        type:'line',
        data:{labels:cd.yearly_trend.years,datasets:[{
          label:'Yield T/Ha',data:cd.yearly_trend.yields,
          borderColor:'#a78bfa',backgroundColor:'rgba(167,139,250,.07)',
          fill:true,tension:.45,borderWidth:2.5,
          pointBackgroundColor:cd.yearly_trend.years.map(y=>y===year?'#f59e0b':'#a78bfa'),
          pointRadius:cd.yearly_trend.years.map(y=>y===year?8:3),
        }]},
        options:{...CHART_OPTS,plugins:{...CHART_OPTS.plugins,
          tooltip:{...tooltipStyle(),callbacks:{label:ctx=>`${ctx.parsed.y.toFixed(3)} T/Ha`}}}}
      });
    } else {
      document.getElementById('ctx-chart3-title').textContent=`üìà Yearly Trend ‚Äî ${crop} (no state-specific data)`;
    }

    // Chart 4: Top states for this crop
    if(cdOk && cd.top_states && cd.top_states.states.length){
      document.getElementById('ctx-chart4-title').textContent=`üèÜ Top States for ${crop}`;
      ctxCharts.c4=new Chart(document.getElementById('ctx-chart4'),{
        type:'bar',
        data:{labels:cd.top_states.states,datasets:[{
          data:cd.top_states.yields,
          backgroundColor:cd.top_states.states.map(s=>s===state?'rgba(245,158,11,.9)':'rgba(0,229,160,.45)'),
          borderRadius:7,borderSkipped:false,
        }]},
        options:{...CHART_OPTS,indexAxis:'y',plugins:{...CHART_OPTS.plugins,legend:{display:false}}}
      });
    }

    section.scrollIntoView({behavior:'smooth',block:'start'});
  }catch(e){console.error('Contextual charts failed:',e);document.getElementById('ctx-stats').innerHTML='<p style="color:var(--muted);padding:20px 0">‚ö†Ô∏è No contextual data available for this combination.</p>';}
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  CROP RECOMMENDER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadRecommend(){
  const btn = document.querySelector('#recommend button');
  const grid = document.getElementById('rec-grid');
  if(!grid) return;
  if(btn){ btn.disabled=true; btn.textContent='‚è≥ Analysing‚Ä¶'; }
  const state  = document.getElementById('f-state').value;
  const season = document.getElementById('f-season').value;
  const year   = document.getElementById('f-year').value;
  const area   = document.getElementById('f-area').value;
  try{
    const d = await fetch(`${API}/recommend?state=${encodeURIComponent(state)}&season=${encodeURIComponent(season)}&year=${year}&area=${area}&n=8`).then(r=>r.json());
    const medals = ['ü•á','ü•à','ü•â'];
    grid.innerHTML = d.recommendations.map((r,i)=>{
      const pct = Math.round((r.yield / d.recommendations[0].yield)*100);
      return `<div class="rec-card fu" style="opacity:0;transform:translateY(20px)">
        <div class="rec-rank">${medals[i]||'#'+(i+1)}</div>
        <div class="rec-name">${r.crop}</div>
        <div style="font-size:.78rem;color:var(--muted);margin-bottom:8px">${r.yield.toFixed(3)} T/Ha</div>
        <div class="rec-bar-wrap" style="height:4px;background:rgba(255,255,255,.07);border-radius:999px;margin-top:12px">
          <div class="rec-bar" style="width:0%;height:100%;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width 1.3s cubic-bezier(.16,1,.3,1)" data-w="${pct}%"></div>
        </div>
        <div style="font-size:.72rem;color:var(--muted);margin-top:4px">Score: ${pct}%</div>
      </div>`;
    }).join('');
    // stagger animate cards + bars
    grid.querySelectorAll('.rec-card').forEach((card,i)=>{
      setTimeout(()=>{
        gsap.to(card, {opacity:1, y:0, duration:.5, ease:'power3.out'});
        const bar = card.querySelector('.rec-bar');
        if(bar) setTimeout(()=>{ bar.style.width=bar.dataset.w; },300);
      }, i*80);
    });
    toast('üå± Top crops ranked for your conditions!');
  }catch(e){ toast('‚ùå Recommender failed: '+e.message,'error'); }
  finally{ if(btn){ btn.disabled=false; btn.textContent='üå± Get AI Recommendations'; } }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  PREDICTION HISTORY
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const HIST_KEY = 'agri_pred_history';

function saveToHistory(pred, body){
  const all = JSON.parse(localStorage.getItem(HIST_KEY)||'[]');
  all.unshift({ pred, body, ts: Date.now() });
  if(all.length > 20) all.pop();
  localStorage.setItem(HIST_KEY, JSON.stringify(all));
  renderHistory();
}

function renderHistory(){
  const all = JSON.parse(localStorage.getItem(HIST_KEY)||'[]');
  const el = document.getElementById('hist-items');
  if(!el) return;
  if(!all.length){
    el.innerHTML=`<div class="placeholder" style="padding:40px 0">
      <div class="placeholder-icon">üìä</div>
      <div style="color:var(--muted);font-size:.88rem">No predictions yet</div>
    </div>`;
    return;
  }
  el.innerHTML = all.map((h,i)=>{
    const d = new Date(h.ts);
    const ts = d.toLocaleDateString()+' '+d.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'});
    return `<div class="hist-item" onclick="refillForm(${i})">
      <div class="hist-yield">${h.pred.yield.toFixed(3)} T/Ha</div>
      <div class="hist-meta">${h.body.crop} ¬∑ ${(h.body.state||'').trim()}</div>
      <div class="hist-meta">${(h.body.season||'').trim()} ¬∑ ${h.body.year} ¬∑ ${h.body.area} Ha</div>
      <div style="font-size:.68rem;color:var(--muted);margin-top:4px">${ts}</div>
    </div>`;
  }).join('');
}

function refillForm(idx){
  const all = JSON.parse(localStorage.getItem(HIST_KEY)||'[]');
  const h = all[idx]; if(!h) return;
  const setVal = (id,v)=>{ const e=document.getElementById(id); if(e) e.value=v; };
  setVal('f-state', h.body.state);
  setVal('f-season', h.body.season);
  setVal('f-crop', h.body.crop);
  setVal('f-year', h.body.year);
  setVal('f-area', h.body.area);
  toggleHistory();
  nav('predict');
  toast(`üìã Form restored: ${h.body.crop}`);
}

function toggleHistory(){
  const panel = document.getElementById('history-panel');
  const overlay = document.getElementById('hist-overlay');
  if(!panel) return;
  const open = panel.classList.toggle('open');
  if(overlay) overlay.classList.toggle('show', open);
  if(open) renderHistory();
}

function clearHistory(){
  localStorage.removeItem(HIST_KEY);
  renderHistory();
  toast('üóëÔ∏è History cleared');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  BATCH PREDICT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function runBatchPredict(){
  const raw = (document.getElementById('batch-input')||{}).value||'';
  const lines = raw.trim().split('\n').filter(l=>l.trim()&&!l.startsWith('State'));
  if(!lines.length){ toast('‚ö†Ô∏è Enter at least one row','error'); return; }
  const inputs = lines.map(l=>{
    const [state,season,crop,year,area] = l.split(',').map(s=>s.trim());
    return { state:state||'', season:season||'', crop:crop||'', year:+(year||2020), area:+(area||1000) };
  });
  const batchSt = document.getElementById('batch-status');
  const tbody = document.getElementById('batch-tbody');
  if(batchSt) batchSt.textContent = '‚è≥ Predicting‚Ä¶';
  try{
    const d = await fetch(`${API}/batch-predict`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({inputs})
    }).then(r=>r.json());
    const tbl = document.getElementById('batch-table');
    if(tbl) tbl.style.display='table';
    if(tbody){
      tbody.innerHTML = d.results.map((r,i)=>`<tr style="border-top:1px solid rgba(255,255,255,.06)">
        <td style="padding:8px">${inputs[i].state}</td>
        <td>${inputs[i].season}</td>
        <td style="color:var(--accent2)">${inputs[i].crop}</td>
        <td>${inputs[i].year}</td>
        <td>${inputs[i].area}</td>
        <td><b style="color:var(--accent)">${r.yield!=null?r.yield.toFixed(3):'Error'}</b></td>
        <td style="color:var(--muted)">${r.production!=null?r.production.toFixed(1):'‚Äî'}</td>
      </tr>`).join('');
    }
    if(batchSt) batchSt.textContent = `‚úÖ ${d.results.length} predictions done`;
    toast(`üì¶ Batch: ${d.results.length} predictions complete`);
  }catch(e){
    if(batchSt) batchSt.textContent='';
    toast('‚ùå Batch failed: '+e.message,'error');
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  CROP COMPARE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let compareList = [];

function addCropToCompare(){
  const sel = document.getElementById('compare-crop-select');
  if(!sel||!sel.value) return;
  const crop = sel.value.trim();
  if(compareList.includes(crop)){ toast('Already added','error'); return; }
  if(compareList.length>=6){ toast('Max 6 crops','error'); return; }
  compareList.push(crop);
  renderCompareChips();
}

function removeCropFromCompare(crop){
  compareList = compareList.filter(c=>c!==crop);
  renderCompareChips();
}

function renderCompareChips(){
  const el = document.getElementById('compare-chips');
  if(!el) return;
  el.innerHTML = compareList.map(c=>`<span class="cmp-chip">
    ${c} <span onclick="removeCropFromCompare('${c.replace(/'/g,'\\\'')}')" style="cursor:pointer;margin-left:4px">√ó</span>
  </span>`).join('');
}

async function runCompare(){
  if(compareList.length<2){ toast('Add at least 2 crops to compare','error'); return; }
  const state  = document.getElementById('f-state').value;
  const season = document.getElementById('f-season').value;
  const year   = document.getElementById('f-year').value;
  const area   = document.getElementById('f-area').value;
  const res = document.getElementById('compare-result');
  if(res) res.innerHTML='<div class="spinner"></div>';
  try{
    const crops = compareList.join(',');
    const d = await fetch(`${API}/crop-compare?state=${encodeURIComponent(state)}&season=${encodeURIComponent(season)}&year=${year}&area=${area}&crops=${encodeURIComponent(crops)}`).then(r=>r.json());
    const maxY = Math.max(...d.comparisons.map(c=>c.yield||0),0.001);
    if(res) res.innerHTML=`<table class="cmp-table">
      <thead><tr><th>Crop</th><th>Yield (T/Ha)</th><th>Production</th><th>Hist Avg</th><th>Bar</th></tr></thead>
      <tbody>${d.comparisons.map(c=>{
        const pct = Math.round((c.yield/maxY)*100);
        return `<tr>
          <td style="color:var(--accent2);font-weight:600">${c.crop}</td>
          <td><b style="color:var(--accent)">${(c.yield||0).toFixed(3)}</b></td>
          <td>${(c.production||0).toFixed(1)}</td>
          <td style="color:var(--muted)">${c.historical_avg||'‚Äî'}</td>
          <td style="min-width:100px"><div class="cmp-bar" style="width:${pct}%;transition:width .6s ease"></div></td>
        </tr>`;
      }).join('')}</tbody>
    </table>`;
    toast(`‚öñÔ∏è Compared ${d.comparisons.length} crops`);
  }catch(e){ if(res) res.innerHTML=''; toast('‚ùå Compare failed: '+e.message,'error'); }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  INIT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded',async()=>{
  initAnimations();
  initTilts();

  // Weather system
  weatherSys = new WeatherSystem();
  seasonOverlay = new SeasonOverlay();

  // ‚îÄ‚îÄ Auto-apply current season immediately (before API loads)
  //    so effects are visible on the whole site from the first frame
  setSeasonTheme(getCurrentSeason());

  // Ripple on predict button
  const btn = document.getElementById('predict-btn');
  if(btn){
    btn.addEventListener('click', e=>{
      const ripple = document.createElement('span');
      ripple.className = 'ripple';
      const rect = btn.getBoundingClientRect();
      const size = Math.max(rect.width, rect.height);
      ripple.style.width = ripple.style.height = size+'px';
      ripple.style.left  = (e.clientX - rect.left - size/2)+'px';
      ripple.style.top   = (e.clientY - rect.top  - size/2)+'px';
      btn.appendChild(ripple);
      setTimeout(()=>ripple.remove(), 700);
    });
  }

  // Load charts when analytics section scrolls into view
  const analyticsEl = document.getElementById('analytics');
  if(analyticsEl){
    const io=new IntersectionObserver(entries=>{
      if(entries[0].isIntersecting){loadCharts();io.disconnect();}
    },{threshold:.1});
    io.observe(analyticsEl);
  }

  // Load history
  renderHistory();

  await Promise.all([loadMeta(),loadStats(),loadTable()]);
});
</script>
</body>
</html>
